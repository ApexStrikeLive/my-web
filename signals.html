<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KH5MTMWP5T"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KH5MTMWP5T');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Signals Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Minimalist Global Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #334155; /* Darker text color */
            padding: 1rem;
        }
        .container {
            max-width: 1200px;
            margin: 1rem auto;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        h1 {
            font-size: 2rem;
            text-align: center;
            color: #1e40af;
            margin-bottom: 1.5rem;
        }

        /* Summary Statistics Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding: 0.75rem;
            background-color: #e0f2fe;
            border-radius: 0.25rem;
        }
        .stat-item {
            background-color: #ffffff;
            border-radius: 0.25rem;
            padding: 0.75rem;
            text-align: center;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .stat-item p {
            font-size: 0.875rem;
            font-weight: 500;
            color: #475569;
        }
        .stat-item span {
            font-size: 1.25rem;
            font-weight: bold;
        }
        .green-text { color: #16a34a; }
        .red-text { color: #dc2626; }
        .blue-text { color: #2563eb; }
        .purple-text { color: #9333ea; }
        .orange-text { color: #ea580c; }

        /* Strategy Stats Styles */
        .strategy-stats-section {
            margin-top: 2rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: #f0f9ff; /* Lighter blue background */
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.05);
        }
        .strategy-stats-section h2 {
            font-size: 1.5rem;
            color: #1e40af;
            margin-bottom: 1rem;
            text-align: center;
        }
        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Larger cards for strategies */
            gap: 1rem;
        }
        .strategy-card {
            background-color: #ffffff;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid #bfdbfe;
        }
        .strategy-card h3 {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 0.75rem;
            text-align: center;
            border-bottom: 1px dashed #e2e8f0;
            padding-bottom: 0.5rem;
        }
        .strategy-card p {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        .strategy-card p strong {
            color: #475569;
        }

        /* Date Section Styles */
        .date-section {
            margin-bottom: 1rem;
            border: 1px solid #bfdbfe;
            border-radius: 0.5rem;
            background-color: #ffffff;
        }
        .date-summary {
            background-color: #dbeafe;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem 0.5rem 0 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            color: #1e40af;
            display: block;
        }
        details[open] .date-summary {
            border-radius: 0.5rem 0.5rem 0 0;
        }

        /* Signal Card Styles (minimalist) */
        .signal-card {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 1rem;
        }
        .signal-card:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .signal-header {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            align-items: center; /* Vertically align items */
            margin-bottom: 0.75rem;
            gap: 0.5rem; /* Space between elements */
        }
        .signal-header h2 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e293b;
            margin-right: auto; /* Push status and button to the right */
        }
        .signal-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.5rem;
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
        }
        .signal-info-item strong {
            color: #475569;
            margin-right: 0.25rem;
        }
        .buy-signal-text { color: #10b981; font-weight: bold; }
        .sell-signal-text { color: #ef4444; font-weight: bold; }
        .status-open { background-color: #bfdbfe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .status-closed-successful { background-color: #dcfce7; color: #16a34a; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .status-closed-unsuccessful { background-color: #fee2e2; color: #dc2626; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .status-closed-sl { background-color: #fce7dcf5; color: #ea580c; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .status-unknown { background-color: #e2e8f0; color: #475569; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }

        /* New: Style for negative profit/loss background */
        .profit-loss-negative-background {
            background-color: #ffebeb; /* Light red background */
            color: #cc0000; /* Darker red text */
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: bold;
        }


        /* TradingView Chart Styles */
        .chart-container {
            margin-top: 1rem;
            background-color: #f8fafc;
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #e2e8f0;
            height: 350px;
            overflow: hidden;
            display: none; /* Hidden by default */
            flex-direction: column;
        }
        .chart-container.active {
            display: flex; /* Show when active */
        }
        .tradingview-widget-container__widget {
            flex-grow: 1;
            height: 100%;
        }
        .tradingview-widget-copyright {
            font-size: 0.7rem;
            color: #787b86;
            text-align: right;
            padding-top: 0.25rem;
        }
        .tradingview-widget-copyright a {
            color: #787b86;
            text-decoration: none;
        }
        .tradingview-widget-copyright a:hover {
            text-decoration: underline;
        }

        /* Chart Button specific style */
        .show-chart-button {
            padding: 0.25rem 0.75rem;
            background-color: #4a5568; /* Darker gray for less prominence than main action button */
            color: white;
            border-radius: 0.25rem;
            border: none;
            cursor: pointer;
            font-size: 0.75rem; /* Smaller font size */
            font-weight: 500;
            transition: background-color 0.2s;
            white-space: nowrap; /* Prevent button text from wrapping */
        }
        .show-chart-button:hover {
            background-color: #2d3748;
        }

        /* TradingView Chat Container (kept for potential future use if a global chat button is desired) */
        #tradingviewChatContainer {
            margin-top: 2rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            border: 1px solid #e2e8f0;
            height: 400px; /* Adjust height as needed */
            display: none; /* Hidden by default */
            flex-direction: column;
        }
        #tradingviewChatContainer.active {
            display: flex; /* Show when active */
        }
        .chat-header {
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
            color: #1e40af;
            margin-bottom: 1rem;
        }
        .chat-widget-wrapper {
            flex-grow: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Trade Signals Overview</h1>

        <div id="statsSection" class="stats-grid">
            <div class="stat-item">
                <p>Total Signals:</p>
                <span id="totalSignals">0</span>
            </div>
            <div class="stat-item">
                <p>Successful:</p>
                <span id="successfulSignals" class="green-text">0</span>
            </div>
            <div class="stat-item">
                <p>Unsuccessful:</p>
                <span id="unsuccessfulSignals" class="red-text">0</span>
            </div>
            <div class="stat-item">
                <p>Open Signals:</p>
                <span id="openSignals" class="blue-text">0</span>
            </div>
            <div class="stat-item">
                <p>Closed 100%:</p>
                <span id="totalClosed100Percent" class="purple-text">0</span>
            </div>
            <div class="stat-item">
                <p>Closed SL (Loss > -3%):</p>
                <span id="closedSLLossGreaterThan3" class="orange-text">0</span>
            </div>
        </div>

        <div id="strategyStatsSection" class="strategy-stats-section hidden">
            <h2>Statistics by Strategy</h2>
            <div id="strategyStatsGrid" class="strategy-grid">
            </div>
        </div>

        <div id="signalsContainer">
            <p class="text-center text-gray-500 py-4">Loading signals...</p>
        </div>

        <div id="tradingviewChatContainer" class="tradingview-widget-container">
            <h2 class="chat-header">TradingView Live Chat</h2>
            <div class="tradingview-widget-container__widget chat-widget-wrapper"></div>
            <div class="tradingview-widget-copyright">
                <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
                    <span class="blue-text">Track all markets on TradingView</span>
                </a>
            </div>
        </div>
    </div>

    <script>
        // Global object to manage TradingView widget instances
        let charts = {}; // To keep track of loaded charts

        // Utility functions for formatting numbers and percentages
        const formatValue = (value, type = 'number', decimals = 2) => {
            if (typeof value !== 'number' || isNaN(value)) return 'N/A';
            if (type === 'percentage') return `${value.toFixed(decimals)}%`;
            return value.toFixed(decimals);
        };

        const coinGeckoIdMap = {
            "BTC": "bitcoin", "ETH": "ethereum", "ADA": "cardano", "CVX": "convex-finance",
            "APT": "aptos", "METIS": "metisdao", "GAS": "gas", "SSV": "ssv-network",
            "AAVE": "aave", "LINK": "chainlink", "SOL": "solana", "BNB": "binancecoin",
            "ORDI": "ordi", "CYBER": "cyberconnect", "MOVR": "moonriver", "GNO": "gnosis",
            "LPT": "livepeer", "ATM": "atletico-madrid-fan-token", "DCR": "decred", "PSG": "paris-saint-germain-fan-token",
        };

        /**
         * Fetches signals data from GitHub and live prices from CoinGecko.
         */
        async function fetchSignals() {
            try {
                const githubUrl = 'https://raw.githubusercontent.com/ApexStrikeLive/my-web/main/traced_signals.json';
                console.log("Fetching historical data...");
                const response = await fetch(githubUrl);

                if (!response.ok) {
                    console.error(`Error fetching historical data! Status: ${response.status}`);
                    return [];
                }

                const fetchedData = await response.json();
                if (!Array.isArray(fetchedData) || fetchedData.length === 0) {
                    console.log("No signals found in the JSON data.");
                    return [];
                }
                console.log("Historical data fetched:", fetchedData.length, "signals.");

                const mergedData = fetchedData.reduce((acc, signal) => {
                    acc[signal.signal_id] = signal;
                    return acc;
                }, {});

                const symbolsToFetch = new Set(Object.values(mergedData)
                    .map(signal => signal.symbol?.split('/')[0]) // Extract base symbol
                    .filter(Boolean)
                    .map(symbol => coinGeckoIdMap[symbol]) // Map to CoinGecko ID
                    .filter(Boolean)); // Filter out any undefined/null mappings

                if (symbolsToFetch.size > 0) {
                    const ids = Array.from(symbolsToFetch).join(',');
                    const vsCurrencies = 'usdt';
                    const livePriceUrl = `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=${vsCurrencies}`;

                    try {
                        console.log("Fetching live prices...");
                        const priceResponse = await fetch(livePriceUrl);
                        if (priceResponse.ok) {
                            const livePrices = await priceResponse.json();
                            Object.values(mergedData).forEach(signal => {
                                const baseSymbol = signal.symbol?.split('/')[0];
                                const coinGeckoId = baseSymbol ? coinGeckoIdMap[baseSymbol] : null;

                                if (coinGeckoId && livePrices[coinGeckoId] && livePrices[coinGeckoId][vsCurrencies]) {
                                    signal.current_price = livePrices[coinGeckoId][vsCurrencies];
                                    if (signal.monitoring_status === 'OPEN' && typeof signal.entry_price === 'number' && signal.entry_price !== 0) {
                                        const priceDiff = signal.signal_type === 'BUY' ? signal.current_price - signal.entry_price : signal.entry_price - signal.current_price;
                                        // Store unrealized P/L percentage
                                        signal.unrealized_profit_loss_percentage = (priceDiff / signal.entry_price) * 100;
                                    } else if (signal.monitoring_status?.includes('CLOSED')) {
                                        // For closed signals, profit_loss_percentage is the realized P/L percentage
                                        if (typeof signal.realized_pnl === 'number' && typeof signal.initial_investment === 'number' && signal.initial_investment !== 0) {
                                            signal.profit_loss_percentage = (signal.realized_pnl / signal.initial_investment) * 100;
                                        } else {
                                            signal.profit_loss_percentage = 0; // Default or N/A
                                        }
                                        signal.unrealized_profit_loss_percentage = 0; // No unrealized PnL for closed signals
                                    }
                                }
                            });
                        } else {
                            console.warn(`Could not fetch live prices (status: ${priceResponse.status}).`);
                        }
                    } catch (priceError) {
                        console.error("Error fetching live prices:", priceError);
                    }
                } else {
                    console.log("No symbols for live price fetching.");
                }

                return Object.values(mergedData);

            } catch (error) {
                console.error("General error in fetchSignals:", error);
                return [];
            }
        }

        /**
         * Updates the summary statistics at the top of the page.
         */
        function updateSummaryStatistics(signals) {
            const statsSection = document.getElementById('statsSection');
            const strategyStatsSection = document.getElementById('strategyStatsSection');
            const strategyStatsGrid = document.getElementById('strategyStatsGrid');

            if (signals.length === 0) {
                statsSection.style.display = 'none';
                strategyStatsSection.classList.add('hidden');
                return;
            }
            statsSection.style.display = 'grid';
            strategyStatsSection.classList.remove('hidden');

            const stats = {
                totalSignals: signals.length,
                successfulSignals: 0,
                unsuccessfulSignals: 0,
                openSignals: 0,
                totalClosed100Percent: 0,
                closedSLLossGreaterThan3: 0,
                strategies: {}
            };

            signals.forEach(signal => {
                const strategyName = signal.strategy_name || 'Unknown Strategy';
                if (!stats.strategies[strategyName]) {
                    stats.strategies[strategyName] = {
                        total: 0,
                        successful: 0,
                        unsuccessful: 0,
                        open: 0,
                        closed100Percent: 0,
                        closedSLLossGreaterThan3: 0,
                    };
                }

                stats.strategies[strategyName].total++;

                if (signal.monitoring_status === "OPEN") {
                    stats.openSignals++;
                    stats.strategies[strategyName].open++;
                } else if (signal.monitoring_status?.includes("CLOSED")) {
                    if (typeof signal.realized_pnl === 'number') {
                        if (signal.realized_pnl > 0) {
                            stats.successfulSignals++;
                            stats.strategies[strategyName].successful++;
                        } else {
                            stats.unsuccessfulSignals++;
                            stats.strategies[strategyName].unsuccessful++;
                        }
                    } else {
                        stats.unsuccessfulSignals++;
                        stats.strategies[strategyName].unsuccessful++;
                    }

                    if (signal.closed_percentage === 100) {
                        stats.totalClosed100Percent++;
                        stats.strategies[strategyName].closed100Percent++;
                    }
                    if (signal.monitoring_status.includes("CLOSED_SL") && typeof signal.profit_loss_percentage === 'number' && signal.profit_loss_percentage < -3) {
                        stats.closedSLLossGreaterThan3++;
                        stats.strategies[strategyName].closedSLLossGreaterThan3++;
                    }
                }
            });

            // Update overall statistics
            document.getElementById('totalSignals').textContent = stats.totalSignals;
            document.getElementById('successfulSignals').textContent = stats.successfulSignals;
            document.getElementById('unsuccessfulSignals').textContent = stats.unsuccessfulSignals;
            document.getElementById('openSignals').textContent = stats.openSignals;
            document.getElementById('totalClosed100Percent').textContent = stats.totalClosed100Percent;
            document.getElementById('closedSLLossGreaterThan3').textContent = stats.closedSLLossGreaterThan3;

            // Render strategy statistics
            strategyStatsGrid.innerHTML = ''; // Clear previous strategy stats
            for (const strategyName in stats.strategies) {
                const strategy = stats.strategies[strategyName];
                const winRate = strategy.total > 0 ? (strategy.successful / strategy.total) * 100 : 0;

                const strategyCardHtml = `
                    <div class="strategy-card">
                        <h3>${strategyName}</h3>
                        <p><strong>Total Signals:</strong> ${strategy.total}</p>
                        <p><strong>Successful:</strong> <span class="green-text">${strategy.successful}</span></p>
                        <p><strong>Unsuccessful:</strong> <span class="red-text">${strategy.unsuccessful}</span></p>
                        <p><strong>Open:</strong> <span class="blue-text">${strategy.open}</span></p>
                        <p><strong>Closed 100%:</strong> <span class="purple-text">${strategy.closed100Percent}</span></p>
                        <p><strong>Closed SL (> -3%):</strong> <span class="orange-text">${strategy.closedSLLossGreaterThan3}</span></p>
                        <p><strong>Win Rate:</strong> <span class="${winRate >= 50 ? 'green-text' : 'red-text'}">${formatValue(winRate, 'percentage', 2)}</span></p>
                    </div>
                `;
                strategyStatsGrid.insertAdjacentHTML('beforeend', strategyCardHtml);
            }
        }

        /**
         * Creates and renders a TradingView chart for a given signal.
         * Only loads if the chart is not already loaded for this signal.
         */
        function createChart(signal, containerId) {
            const chartContainer = document.getElementById(containerId);
            if (!chartContainer || !signal.symbol) {
                console.error(`Cannot create chart for signal ${signal?.signal_id || 'N/A'}: Container not found or symbol missing.`);
                if (chartContainer) chartContainer.innerHTML = '<p class="text-center text-gray-500">Chart not available (missing symbol).</p>';
                return;
            }

            // Only load the script if the chart hasn't been loaded for this signal ID yet
            if (!charts[signal.signal_id]) {
                const [base, quote] = signal.symbol.split('/');
                const tradingViewSymbol = `BINANCE:${base}${quote}`;

                let tvInterval = "D";
                if (signal.timeframe) {
                    if (signal.timeframe.includes('m')) tvInterval = signal.timeframe.replace('m', '');
                    else if (signal.timeframe.includes('h')) tvInterval = signal.timeframe.replace('h', 'H');
                    else if (signal.timeframe === 'DAILY') tvInterval = "D";
                }

                const innerWidgetId = `tradingview_widget_${signal.signal_id}`;

                const widgetConfig = {
                    "width": "100%", "height": "350", "symbol": tradingViewSymbol,
                    "interval": tvInterval, "timezone": "Etc/UTC", "theme": "light", "style": "1",
                    "locale": "en", "toolbar_bg": "#f1f5f9", "enable_publishing": false,
                    "allow_symbol_change": true, "container_id": innerWidgetId,
                    "hide_side_toolbar": false, "hide_top_toolbar": false, "withdateranges": true,
                    "save_image": false, "details": false, "hotlist": false, "calendar": false,
                    "studies": ["RSI@tv-basicstudies", "MACD@tv-basicstudies"],
                    "show_popup_button": true, "popup_width": "1000", "popup_height": "650"
                };

                const tradingViewHtml = `
                    <div class="tradingview-widget-container" style="height:100%; width:100%;">
                        <div id="${innerWidgetId}" class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%;"></div>
                        <div class="tradingview-widget-copyright">
                            <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
                                <span class="blue-text">Track all markets on TradingView</span>
                            </a>
                        </div>
                    </div>
                `;
                chartContainer.innerHTML = tradingViewHtml;

                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
                script.async = true;
                script.textContent = JSON.stringify(widgetConfig);

                chartContainer.querySelector(`#${innerWidgetId}`).closest('.tradingview-widget-container').appendChild(script);

                charts[signal.signal_id] = true; // Mark chart as loaded
            }
        }

        /**
         * Toggles the display of a chart for a given signal.
         * Loads the chart if it's not already loaded.
         */
        function toggleChartDisplay(signal, buttonElement) {
            const chartContainerId = `chart-${signal.signal_id}`;
            const chartContainer = document.getElementById(chartContainerId);

            if (!chartContainer) {
                console.error(`Chart container not found for signal ID: ${signal.signal_id}`);
                return;
            }

            if (chartContainer.classList.contains('active')) {
                // Hide chart
                chartContainer.classList.remove('active');
                buttonElement.textContent = 'Show Chart';
            } else {
                // Show chart and load if not already loaded
                chartContainer.classList.add('active');
                buttonElement.textContent = 'Hide Chart';
                createChart(signal, chartContainerId); // Attempt to create/load chart
            }
        }


        /**
         * Renders the signals data into the HTML, grouped by date.
         */
        function renderSignals(signals) {
            const signalsContainer = document.getElementById('signalsContainer');
            signalsContainer.innerHTML = ''; // Clear previous content

            // We don't clear all charts here, but manage their visibility individually.
            // Reset the 'charts' object to ensure new ones are loaded if necessary upon re-render.
            // A more complex solution might cache chart instances if performance becomes an issue.
            charts = {};

            if (signals.length === 0) {
                signalsContainer.innerHTML = '<p class="text-center text-gray-600 py-8 text-lg">No signals to display.</p>';
                return;
            }

            const sortedSignalsGlobally = [...signals].sort((a, b) => new Date(b.entry_time) - new Date(a.entry_time));

            const signalsByDate = sortedSignalsGlobally.reduce((acc, signal) => {
                const entryTime = signal.entry_time ? new Date(signal.entry_time) : null;
                const date = entryTime ? entryTime.toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-') : 'Unknown Date';
                (acc[date] = acc[date] || []).push(signal);
                return acc;
            }, {});

            // Define the desired order of statuses
            const statusOrder = {
                "OPEN": 1,
                "CLOSED_SUCCESSFUL": 2, // Full Take Profit
                "PARTIALLY_CLOSED": 3, // Assuming this as a separate status for sorting
                "CLOSED_SL": 4, // Close Stop Loss
                "CLOSED_UNSUCCESSFUL": 5, // Any other unsuccessful closures
                "UNKNOWN": 99 // For any other status
            };

            // Use the actual current date for "today"
            const today = new Date();
            const todayDateString = today.toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');

            for (const date in signalsByDate) {
                const isToday = date === todayDateString;
                const detailsElement = document.createElement('details');
                detailsElement.className = 'date-section';
                // Open today's signals by default, or the latest date if not today
                if (isToday || (Object.keys(signalsByDate).indexOf(date) === 0 && Object.keys(signalsByDate).length > 1) || Object.keys(signalsByDate).length === 1) {
                    detailsElement.setAttribute('open', '');
                }

                const summaryText = `Signals from ${date}${isToday ? ' (Today)' : ''}`;
                detailsElement.innerHTML = `<summary class="date-summary">${summaryText}</summary><div class="p-4"></div>`;
                const dateSignalsDiv = detailsElement.querySelector('.p-4');

                // Sort signals for the current date
                const sortedDateSignals = signalsByDate[date].sort((a, b) => {
                    const statusA = a.monitoring_status || 'UNKNOWN';
                    const statusB = b.monitoring_status || 'UNKNOWN';
                    const orderA = statusOrder[statusA] || statusOrder.UNKNOWN;
                    const orderB = statusOrder[statusB] || statusOrder.UNKNOWN;

                    // Primary sort by status order
                    if (orderA !== orderB) {
                        return orderA - orderB;
                    }

                    // Secondary sort (e.g., by entry time for signals with the same status)
                    const timeA = new Date(a.entry_time).getTime();
                    const timeB = new Date(b.entry_time).getTime();
                    return timeB - timeA; // Most recent first for same status
                });


                sortedDateSignals.forEach(signal => {
                    const signalTypeClass = signal.signal_type === 'BUY' ? 'buy-signal-text' : 'sell-signal-text';

                    let statusClass = 'status-unknown';
                    let statusText = signal.monitoring_status || 'N/A';
                    if (signal.monitoring_status === 'OPEN') {
                        statusClass = 'status-open';
                    } else if (signal.monitoring_status === 'CLOSED_SUCCESSFUL') {
                        statusClass = 'status-closed-successful';
                        statusText = 'Closed (Successful)';
                    } else if (signal.monitoring_status === 'CLOSED_UNSUCCESSFUL') {
                        statusClass = 'status-closed-unsuccessful';
                        statusText = 'Closed (Unsuccessful)';
                    } else if (signal.monitoring_status === 'CLOSED_SL') {
                        statusClass = 'status-closed-sl';
                        statusText = 'Closed (Stop Loss)';
                    } else if (signal.monitoring_status === 'PARTIALLY_CLOSED') { // Handle PARTIALLY_CLOSED explicitly
                        statusClass = 'status-closed-successful'; // Or a new class for partially closed
                        statusText = 'Partially Closed';
                    }


                    // Determine profit/loss percentage display
                    let profitLossDisplay = 'N/A';
                    let profitLossClass = '';

                    if (signal.monitoring_status === 'OPEN' && typeof signal.unrealized_profit_loss_percentage === 'number') {
                        profitLossDisplay = `${formatValue(signal.unrealized_profit_loss_percentage, 'percentage', 2)}`;
                        profitLossClass = signal.unrealized_profit_loss_percentage >= 0 ? 'green-text' : 'red-text';
                    } else if (signal.monitoring_status?.includes('CLOSED') && typeof signal.profit_loss_percentage === 'number') {
                        profitLossDisplay = `${formatValue(signal.profit_loss_percentage, 'percentage', 2)}`;
                        // Apply red background if it's CLOSED_SL and a negative percentage
                        if (signal.monitoring_status === 'CLOSED_SL' && signal.profit_loss_percentage < 0) {
                            profitLossClass = 'profit-loss-negative-background';
                        } else {
                            profitLossClass = signal.profit_loss_percentage >= 0 ? 'green-text' : 'red-text';
                        }
                    }

                    const signalCardHtml = `
                        <div class="signal-card" id="signal-${signal.signal_id}">
                            <div class="signal-header">
                                <h2>${signal.symbol || 'N/A'} <span class="${signalTypeClass}">(${signal.signal_type || 'N/A'})</span></h2>
                                <span class="${statusClass}">${statusText}</span>
                                <button class="show-chart-button" data-signal-id="${signal.signal_id}">Show Chart</button>
                            </div>
                            <div class="signal-info-grid">
                                <div class="signal-info-item"><strong>Strategy:</strong> <span>${signal.strategy_name || 'N/A'}</span></div>
                                <div class="signal-info-item"><strong>Entry Price:</strong> <span>${formatValue(signal.entry_price, 'number', 4)}</span></div>
                                <div class="signal-info-item"><strong>Current Price:</strong> <span>${formatValue(signal.current_price, 'number', 4)}</span></div>
                                <div class="signal-info-item"><strong>Stop Loss:</strong> <span>${formatValue(signal.stop_loss_price, 'number', 4)}</span></div>
                                <div class="signal-info-item"><strong>Profit/Loss:</strong> <span class="${profitLossClass}">${profitLossDisplay}</span></div>
                                <div class="signal-info-item"><strong>Entry Time:</strong> <span>${signal.entry_time ? new Date(signal.entry_time).toLocaleString() : 'N/A'}</span></div>
                                <div class="signal-info-item"><strong>Exit Time:</strong> <span>${signal.exit_time ? new Date(signal.exit_time).toLocaleString() : 'N/A'}</span></div>
                                <div class="signal-info-item"><strong>Interval:</strong> <span>${signal.timeframe || 'N/A'}</span></div>
                            </div>
                            <div class="chart-container" id="chart-${signal.signal_id}">
                                </div>
                        </div>
                    `;
                    dateSignalsDiv.insertAdjacentHTML('beforeend', signalCardHtml);
                });
                signalsContainer.appendChild(detailsElement);
            }

            // Attach event listeners to the "Show Chart" buttons after they are in the DOM
            document.querySelectorAll('.show-chart-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const signalId = event.target.dataset.signalId;
                    // Find the signal from the original (unsorted) signals array or a pre-sorted map for efficiency
                    // For simplicity, we'll re-find it from the global `signals` array.
                    const signal = signals.find(s => s.signal_id === signalId);
                    if (signal) {
                        toggleChartDisplay(signal, event.target);
                    }
                });
            });
        }

        /**
         * Initializes the TradingView Live Chat widget.
         * (This function is still present but currently not called as the global chat button is removed.)
         */
        function initializeTradingViewChat() {
            const chatContainerWrapper = document.getElementById('tradingviewChatContainer').querySelector('.chat-widget-wrapper');
            if (chatContainerWrapper && chatContainerWrapper.innerHTML.trim() === '') { // Only load if not already loaded
                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-social-streams.js';
                script.async = true;
                script.textContent = JSON.stringify({
                    "width": "100%",
                    "height": "100%",
                    "colorTheme": "light",
                    "feedMode": "recent",
                    "is": false,
                    "locale": "en",
                    "backgroundColor": "#f0f4f8" // Match body background
                });
                chatContainerWrapper.appendChild(script);
            }
        }

        // Initial data fetch and rendering
        document.addEventListener('DOMContentLoaded', async () => {
            const signals = await fetchSignals();
            updateSummaryStatistics(signals);
            renderSignals(signals);

            // Set up interval for refreshing data (e.g., every 5 minutes)
            setInterval(async () => {
                console.log("Refreshing data...");
                const updatedSignals = await fetchSignals();
                updateSummaryStatistics(updatedSignals);
                // Re-render signals will also re-attach event listeners to new buttons
                renderSignals(updatedSignals);
            }, 300000); // 300000 ms = 5 minutes
        });
    </script>
</body>
</html>
