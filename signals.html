<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Signals Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Minimalist Global Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #334155; /* Darker text color */
            padding: 1rem;
        }
        .container {
            max-width: 1200px;
            margin: 1rem auto;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        h1 {
            font-size: 2rem;
            text-align: center;
            color: #1e40af;
            margin-bottom: 1.5rem;
        }

        /* Summary Statistics Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding: 0.75rem;
            background-color: #e0f2fe;
            border-radius: 0.25rem;
        }
        .stat-item {
            background-color: #ffffff;
            border-radius: 0.25rem;
            padding: 0.75rem;
            text-align: center;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .stat-item p {
            font-size: 0.875rem;
            font-weight: 500;
            color: #475569;
        }
        .stat-item span {
            font-size: 1.25rem;
            font-weight: bold;
        }
        .green-text { color: #16a34a; }
        .red-text { color: #dc2626; }
        .blue-text { color: #2563eb; }
        .purple-text { color: #9333ea; }
        .orange-text { color: #ea580c; }

        /* Date Section Styles */
        .date-section {
            margin-bottom: 1rem;
            border: 1px solid #bfdbfe;
            border-radius: 0.5rem;
            background-color: #ffffff;
        }
        .date-summary {
            background-color: #dbeafe;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem 0.5rem 0 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            color: #1e40af;
            display: block;
        }
        details[open] .date-summary {
            border-radius: 0.5rem 0.5rem 0 0;
        }
        
        /* Signal Card Styles (minimalist) */
        .signal-card {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 1rem;
        }
        .signal-card:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .signal-header h2 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e293b;
        }
        .signal-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.5rem;
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
        }
        .signal-info-item strong {
            color: #475569;
            margin-right: 0.25rem;
        }
        .buy-signal-text { color: #10b981; font-weight: bold; }
        .sell-signal-text { color: #ef4444; font-weight: bold; }
        .status-open { background-color: #bfdbfe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .status-closed { background-color: #e2e8f0; color: #475569; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        
        /* TradingView Chart Styles */
        .chart-container {
            margin-top: 1rem;
            background-color: #f8fafc;
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #e2e8f0;
            height: 350px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .tradingview-widget-container__widget {
            flex-grow: 1;
            height: 100%;
        }
        .tradingview-widget-copyright {
            font-size: 0.7rem;
            color: #787b86;
            text-align: right;
            padding-top: 0.25rem;
        }
        .tradingview-widget-copyright a {
            color: #787b86;
            text-decoration: none;
        }
        .tradingview-widget-copyright a:hover {
            text-decoration: underline;
        }

        /* Take Profit Table Styles */
        .tp-table-wrapper {
            overflow-x: auto;
            margin-top: 0.75rem;
            margin-bottom: 1rem;
        }
        .tp-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        .tp-table th, .tp-table td {
            padding: 0.4rem 0.6rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
        }
        .tp-table th {
            background-color: #f0f4f8;
            font-weight: 600;
            color: #64748b;
        }
        .tp-table tr:hover {
            background-color: #f8fafc;
        }
        .tp-achieved {
            background-color: #dcfce7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Trade Signals Overview</h1>

        <div id="statsSection" class="stats-grid">
            <div class="stat-item">
                <p>Total Signals:</p>
                <span id="totalSignals">0</span>
            </div>
            <div class="stat-item">
                <p>Successful:</p>
                <span id="successfulSignals" class="green-text">0</span>
            </div>
            <div class="stat-item">
                <p>Unsuccessful:</p>
                <span id="closedUnsuccessfulSignals" class="red-text">0</span>
            </div>
            <div class="stat-item">
                <p>Open Signals:</p>
                <span id="openSignals" class="blue-text">0</span>
            </div>
            <div class="stat-item">
                <p>Closed 100%:</p>
                <span id="totalClosed100Percent" class="purple-text">0</span>
            </div>
            <div class="stat-item">
                <p>SL (Loss > -3%):</p>
                <span id="closedSLLossGreaterThan3" class="orange-text">0</span>
            </div>
        </div>

        <div id="signalsContainer">
            <p class="text-center text-gray-500 py-4">Ładowanie sygnałów...</p>
        </div>
    </div>

    <script>
        // Global object to manage TradingView widget instances
        let charts = {};

        // Definition for Take Profit levels
        const tpLevelsDefinition = [
            { level: 0.7, close_percentage: 25 }, { level: 0.8, close_percentage: 0 },
            { level: 1.2, close_percentage: 25 }, { level: 1.5, close_percentage: 0 },
            { level: 1.8, close_percentage: 0 }, { level: 2.0, close_percentage: 25 },
            { level: 2.4, close_percentage: 0 }, { level: 2.6, close_percentage: 0 },
            { level: 2.8, close_percentage: 0 }, { level: 3.0, close_percentage: 0 },
            { level: 3.3, close_percentage: 100 }
        ];

        // Utility functions for formatting numbers and percentages
        const formatValue = (value, type = 'number', decimals = 2) => {
            if (typeof value !== 'number' || isNaN(value)) return 'N/A';
            if (type === 'percentage') return `${value.toFixed(decimals)}%`;
            return value.toFixed(decimals);
        };

        const coinGeckoIdMap = {
            "BTC": "bitcoin", "ETH": "ethereum", "ADA": "cardano", "CVX": "convex-finance",
            "APT": "aptos", "METIS": "metisdao", "GAS": "gas", "SSV": "ssv-network",
            "AAVE": "aave", "LINK": "chainlink", "SOL": "solana", "BNB": "binancecoin",
            "ORDI": "ordi", "CYBER": "cyberconnect", "MOVR": "moonriver", "GNO": "gnosis",
            "LPT": "livepeer", "ATM": "atletico-madrid-fan-token", "DCR": "decred", "PSG": "paris-saint-germain-fan-token",
        };

        /**
         * Fetches signals data from GitHub and live prices from CoinGecko.
         */
        async function fetchSignals() {
            try {
                const githubUrl = 'https://raw.githubusercontent.com/ApexStrikeLive/my-web/main/traced_signals.json';
                console.log("Fetching historical data...");
                const response = await fetch(githubUrl);
                
                if (!response.ok) {
                    console.error(`Error fetching historical data! Status: ${response.status}`);
                    return [];
                }

                const fetchedData = await response.json();
                if (!Array.isArray(fetchedData) || fetchedData.length === 0) {
                    console.log("No signals found in the JSON data.");
                    return [];
                }
                console.log("Historical data fetched:", fetchedData.length, "signals.");

                const mergedData = fetchedData.reduce((acc, signal) => {
                    acc[signal.signal_id] = signal;
                    return acc;
                }, {});

                const symbolsToFetch = new Set(Object.values(mergedData)
                    .map(signal => coinGeckoIdMap[signal.symbol?.split('/')[0]])
                    .filter(Boolean));

                if (symbolsToFetch.size > 0) {
                    const ids = Array.from(symbolsToFetch).join(',');
                    const vsCurrencies = 'usdt';
                    const livePriceUrl = `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=${vsCurrencies}`;
                    
                    try {
                        console.log("Fetching live prices...");
                        const priceResponse = await fetch(livePriceUrl);
                        if (priceResponse.ok) {
                            const livePrices = await priceResponse.json();
                            Object.values(mergedData).forEach(signal => {
                                const baseSymbol = signal.symbol?.split('/')[0];
                                const coinGeckoId = baseSymbol ? coinGeckoIdMap[baseSymbol] : null;

                                if (coinGeckoId && livePrices[coinGeckoId] && livePrices[coinGeckoId][vsCurrencies]) {
                                    signal.current_price = livePrices[coinGeckoId][vsCurrencies];
                                    if (signal.monitoring_status === 'OPEN' && typeof signal.entry_price === 'number' && signal.entry_price !== 0) {
                                        const priceDiff = signal.signal_type === 'BUY' ? signal.current_price - signal.entry_price : signal.entry_price - signal.current_price;
                                        signal.profit_loss_percentage = (priceDiff / signal.entry_price) * 100; // Corrected for SELL
                                        signal.unrealized_pnl = priceDiff * (signal.initial_investment / signal.entry_price);
                                    } else if (signal.monitoring_status?.includes('CLOSED')) {
                                        signal.unrealized_pnl = 0; // No unrealized PnL for closed signals
                                        if (typeof signal.realized_pnl === 'number' && typeof signal.initial_investment === 'number' && signal.initial_investment !== 0) {
                                            signal.profit_loss_percentage = (signal.realized_pnl / signal.initial_investment) * 100;
                                        } else {
                                            signal.profit_loss_percentage = 0;
                                        }
                                    }
                                }
                            });
                        } else {
                            console.warn(`Could not fetch live prices (status: ${priceResponse.status}).`);
                        }
                    } catch (priceError) {
                        console.error("Error fetching live prices:", priceError);
                    }
                } else {
                    console.log("No symbols for live price fetching.");
                }

                return Object.values(mergedData);

            } catch (error) {
                console.error("General error in fetchSignals:", error);
                return [];
            }
        }

        /**
         * Updates the summary statistics at the top of the page.
         */
        function updateSummaryStatistics(signals) {
            const statsSection = document.getElementById('statsSection');
            if (signals.length === 0) {
                statsSection.style.display = 'none';
                return;
            }
            statsSection.style.display = 'grid';

            const stats = {
                totalSignals: signals.length,
                successfulSignals: 0,
                closedUnsuccessfulSignals: 0,
                openSignals: 0,
                totalClosed100Percent: 0,
                closedSLLossGreaterThan3: 0
            };

            signals.forEach(signal => {
                if (signal.monitoring_status === "OPEN") {
                    stats.openSignals++;
                } else if (signal.monitoring_status?.includes("CLOSED")) {
                    if (typeof signal.realized_pnl === 'number' && signal.realized_pnl > 0) {
                        stats.successfulSignals++;
                    } else {
                        stats.closedUnsuccessfulSignals++;
                    }
                    if (signal.closed_percentage === 100) {
                        stats.totalClosed100Percent++;
                    }
                    if (signal.monitoring_status.includes("CLOSED_SL") && typeof signal.profit_loss_percentage === 'number' && signal.profit_loss_percentage < -3) {
                        stats.closedSLLossGreaterThan3++;
                    }
                }
            });

            document.getElementById('totalSignals').textContent = stats.totalSignals;
            document.getElementById('successfulSignals').textContent = stats.successfulSignals;
            document.getElementById('closedUnsuccessfulSignals').textContent = stats.closedUnsuccessfulSignals;
            document.getElementById('openSignals').textContent = stats.openSignals;
            document.getElementById('totalClosed100Percent').textContent = stats.totalClosed100Percent;
            document.getElementById('closedSLLossGreaterThan3').textContent = stats.closedSLLossGreaterThan3;
        }

        /**
         * Creates and renders a TradingView chart for a given signal.
         */
        function createChart(signal, containerId) {
            const chartContainer = document.getElementById(containerId);
            if (!chartContainer || !signal.symbol) {
                console.error(`Cannot create chart for signal ${signal?.signal_id || 'N/A'}: Container not found or symbol missing.`);
                if (chartContainer) chartContainer.innerHTML = '<p class="text-center text-gray-500">Wykres niedostępny (brak symbolu).</p>';
                return;
            }
            chartContainer.innerHTML = ''; // Clear previous chart

            const [base, quote] = signal.symbol.split('/');
            const tradingViewSymbol = `BINANCE:${base}${quote}`;

            let tvInterval = "D";
            if (signal.timeframe) {
                if (signal.timeframe.includes('m')) tvInterval = signal.timeframe.replace('m', '');
                else if (signal.timeframe.includes('h')) tvInterval = signal.timeframe.replace('h', 'H');
                else if (signal.timeframe === 'DAILY') tvInterval = "D";
            }

            const innerWidgetId = `tradingview_widget_${signal.signal_id}`;
            
            const widgetConfig = {
                "width": "100%", "height": "350", "symbol": tradingViewSymbol,
                "interval": tvInterval, "timezone": "Etc/UTC", "theme": "light", "style": "1",
                "locale": "en", "toolbar_bg": "#f1f5f9", "enable_publishing": false,
                "allow_symbol_change": true, "container_id": innerWidgetId,
                "hide_side_toolbar": false, "hide_top_toolbar": false, "withdateranges": true,
                "save_image": false, "details": false, "hotlist": false, "calendar": false,
                "studies": ["RSI@tv-basicstudies", "MACD@tv-basicstudies"],
                "show_popup_button": true, "popup_width": "1000", "popup_height": "650"
            };

            const tradingViewHtml = `
                <div class="tradingview-widget-container" style="height:100%; width:100%;">
                    <div id="${innerWidgetId}" class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%;"></div>
                    <div class="tradingview-widget-copyright">
                        <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
                            <span class="blue-text">Track all markets on TradingView</span>
                        </a>
                    </div>
                </div>
            `;
            chartContainer.innerHTML = tradingViewHtml;

            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
            script.async = true;
            script.textContent = JSON.stringify(widgetConfig);
            
            chartContainer.querySelector(`#${innerWidgetId}`).closest('.tradingview-widget-container').appendChild(script);

            charts[signal.signal_id] = chartContainer;
        }

        /**
         * Generates HTML for the Take Profit table rows.
         */
        function generateTpTableRows(signal) {
            return tpLevelsDefinition.map(tp => {
                const tpPrice = signal.signal_type === 'BUY'
                    ? signal.entry_price * (1 + tp.level / 100)
                    : signal.entry_price * (1 - tp.level / 100);
                
                const activatedTpLevelKey = `tp_${String(tp.level).replace('.', '')}`;
                const isTPReached = signal.activated_tp_levels?.includes(activatedTpLevelKey);
                
                return `
                    <tr class="${isTPReached ? 'tp-achieved' : ''}">
                        <td>${formatValue(tp.level, 'number', 1)}</td>
                        <td>${formatValue(tpPrice, 'number', 4)}</td>
                        <td>${formatValue(tp.level, 'percentage', 2)}</td>
                        <td>${isTPReached ? 'Tak' : 'Nie'}</td>
                        <td>${tp.close_percentage > 0 ? tp.close_percentage + '%' : '0%'}</td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Renders the signals data into the HTML, grouped by date.
         */
        function renderSignals(signals) {
            const signalsContainer = document.getElementById('signalsContainer');
            signalsContainer.innerHTML = ''; // Clear previous content

            // Clear all existing charts directly to avoid re-rendering issues
            for (const id in charts) {
                if (charts[id]) {
                    charts[id].innerHTML = '';
                }
            }
            charts = {}; // Reset chart references

            if (signals.length === 0) {
                signalsContainer.innerHTML = '<p class="text-center text-gray-600 py-8 text-lg">Brak sygnałów do wyświetlenia.</p>';
                return;
            }

            const sortedSignals = [...signals].sort((a, b) => new Date(b.entry_time) - new Date(a.entry_time));

            const signalsByDate = sortedSignals.reduce((acc, signal) => {
                const entryTime = signal.entry_time ? new Date(signal.entry_time) : null;
                const date = entryTime ? entryTime.toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-') : 'Unknown Date';
                (acc[date] = acc[date] || []).push(signal);
                return acc;
            }, {});

            // Use the actual current date for "today"
            const today = new Date();
            const todayDateString = today.toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');

            for (const date in signalsByDate) {
                const isToday = date === todayDateString;
                const detailsElement = document.createElement('details');
                detailsElement.className = 'date-section';
                // Open today's signals by default, or the latest date if not today
                if (isToday || (Object.keys(signalsByDate).indexOf(date) === 0 && Object.keys(signalsByDate).length > 1) || Object.keys(signalsByDate).length === 1) {
                    detailsElement.setAttribute('open', '');
                }

                const summaryText = `Sygnały z dnia ${date}${isToday ? ' (Dziś)' : ''}`;
                detailsElement.innerHTML = `<summary class="date-summary">${summaryText}</summary><div class="p-4"></div>`;
                const dateSignalsDiv = detailsElement.querySelector('.p-4');

                signalsByDate[date].forEach(signal => {
                    const signalTypeClass = signal.signal_type === 'BUY' ? 'buy-signal-text' : 'sell-signal-text';
                    const pnlClass = (typeof signal.profit_loss_percentage === 'number' && !isNaN(signal.profit_loss_percentage)) ?
                        (signal.profit_loss_percentage >= 0 ? 'green-text' : 'red-text') : '';
                    const realizedPnlClass = (typeof signal.realized_pnl === 'number' && !isNaN(signal.realized_pnl)) ?
                        (signal.realized_pnl >= 0 ? 'green-text' : 'red-text') : '';
                    const statusClass = signal.monitoring_status === 'OPEN' ? 'status-open' : 'status-closed';

                    const signalCardHtml = `
                        <div class="signal-card" id="signal-${signal.signal_id}">
                            <div class="signal-header">
                                <h2>${signal.symbol || 'N/A'} <span class="${signalTypeClass}">(${signal.signal_type || 'N/A'})</span></h2>
                                <span class="${statusClass}">${signal.monitoring_status || 'N/A'}</span>
                            </div>
                            <div class="signal-info-grid">
                                <div class="signal-info-item"><strong>Strategia:</strong> <span>${signal.strategy_name || 'N/A'}</span></div>
                                <div class="signal-info-item"><strong>Cena wejścia:</strong> <span>${formatValue(signal.entry_price, 'number', 4)}</span></div>
                                <div class="signal-info-item"><strong>Aktualna cena:</strong> <span>${formatValue(signal.current_price, 'number', 4)}</span></div>
                                <div class="signal-info-item"><strong>Stop Loss:</strong> <span>${formatValue(signal.stop_loss_price, 'number', 4)}</span></div>
                                <div class="signal-info-item"><strong>Czas wejścia:</strong> <span>${signal.entry_time ? new Date(signal.entry_time).toLocaleString() : 'N/A'}</span></div>
                                <div class="signal-info-item"><strong>Czas wyjścia:</strong> <span>${signal.exit_time ? new Date(signal.exit_time).toLocaleString() : 'N/A'}</span></div>
                                <div class="signal-info-item"><strong>Interwał:</strong> <span>${signal.timeframe || 'N/A'}</span></div>
                                <div class="signal-info-item"><strong>Początkowa inv.:</strong> <span>$${formatValue(signal.initial_investment, 'number', 2)}</span></div>
                                <div class="signal-info-item"><strong>Z/S (%):</strong> <span class="${pnlClass}">${formatValue(signal.profit_loss_percentage, 'percentage', 2)}</span></div>
                                <div class="signal-info-item"><strong>Niezrealizowany Z/S:</strong> <span class="${pnlClass}">$${formatValue(signal.unrealized_pnl, 'number', 2)}</span></div>
                                <div class="signal-info-item"><strong>Zrealizowany Z/S:</strong> <span class="${realizedPnlClass}">$${formatValue(signal.realized_pnl, 'number', 2)}</span></div>
                                <div class="signal-info-item"><strong>Zamknięto %:</strong> <span>${formatValue(signal.closed_percentage, 'number', 0)}%</span></div>
                            </div>

                            <h4 class="text-sm font-semibold mt-4 mb-2 text-gray-700">Poziomy Take Profit:</h4>
                            <div class="tp-table-wrapper">
                                <table class="tp-table">
                                    <thead>
                                        <tr>
                                            <th>Poziom</th><th>Cena</th><th>Zysk (%)</th><th>Osiągnięto</th><th>Zamknięto %</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${generateTpTableRows(signal)}
                                    </tbody>
                                </table>
                            </div>
                            <div class="chart-container" id="chart-${signal.signal_id}"></div>
                        </div>
                    `;
                    dateSignalsDiv.insertAdjacentHTML('beforeend', signalCardHtml);

                    // Render TradingView chart after the card is added to DOM
                    if (signal.symbol) {
                        createChart(signal, `chart-${signal.signal_id}`);
                    } else {
                        document.getElementById(`chart-${signal.signal_id}`).innerHTML = '<p class="text-center text-gray-500">Wykres niedostępny (brak symbolu).</p>';
                    }
                });
                signalsContainer.appendChild(detailsElement);
            }
        }

        // Initial fetch and render
        document.addEventListener('DOMContentLoaded', async () => {
            const signals = await fetchSignals();
            updateSummaryStatistics(signals);
            renderSignals(signals);

            // Set up interval for refreshing data every 5 minutes (300000 milliseconds)
            setInterval(async () => {
                const updatedSignals = await fetchSignals();
                updateSummaryStatistics(updatedSignals);
                renderSignals(updatedSignals);
            }, 300000);
        });
    </script>
</body>
</html>
