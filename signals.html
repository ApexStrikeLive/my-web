<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Signals Dashboard - Strategy Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #334155; /* Darker text color */
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Styles for Strategy Statistics */
        .strategy-statistics-section {
            background-color: #e6fffa; /* Light teal */
            border: 1px solid #81e6d9; /* Medium teal border */
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        .strategy-card {
            background-color: #ffffff;
            border: 1px solid #a7d9d5; /* Light teal border */
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .strategy-card h3 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #008080; /* Dark teal */
            margin-bottom: 1rem;
        }
        .strategy-card p {
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        .strategy-card p strong {
            color: #2c3e50; /* Darker text */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <h1 class="text-4xl font-extrabold text-center text-blue-700 mb-8">Trade Signals Dashboard</h1>

        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6 p-4 bg-blue-50 rounded-lg shadow-sm text-center">
            <div class="p-3 bg-white rounded-md shadow-sm">
                <p class="text-lg font-medium text-blue-700">Total Signals:</p>
                <p id="totalSignals" class="text-2xl font-bold text-gray-900">0</p>
            </div>
            <div class="p-3 bg-white rounded-md shadow-sm">
                <p class="text-lg font-medium text-blue-700">Successful Signals:</p>
                <p id="successfulSignals" class="text-2xl font-bold text-green-600">0</p>
            </div>
            <div class="p-3 bg-white rounded-md shadow-sm">
                <p class="text-lg font-medium text-blue-700">Unsuccessful Signals:</p>
                <p id="closedUnsuccessfulSignals" class="text-2xl font-bold text-red-600">0</p>
            </div>
            <div class="p-3 bg-white rounded-md shadow-sm">
                <p class="text-lg font-medium text-blue-700">Open Signals:</p>
                <p id="openSignals" class="text-2xl font-bold text-blue-600">0</p>
            </div>
            <div class="p-3 bg-white rounded-md shadow-sm">
                <p class="text-lg font-medium text-blue-700">Total Closed 100%:</p>
                <p id="totalClosed100Percent" class="text-2xl font-bold text-purple-600">0</p>
            </div>
            <div class="p-3 bg-white rounded-md shadow-sm">
                <p class="text-lg font-medium text-blue-700">Closed SL (Loss > -3%):</p>
                <p id="closedSLLossGreaterThan3" class="text-2xl font-bold text-orange-600">0</p>
            </div>
        </div>

        <div class="strategy-statistics-section">
            <h2 class="text-2xl font-bold text-teal-700 mb-4">Statistics by Strategy</h2>
            <div id="strategyStatisticsContainer" class="strategy-grid">
                <p class="text-gray-600 col-span-full">Loading strategy statistics...</p>
            </div>
        </div>

        </div>

    <script>
        let currentSignalsData = [];

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        const formatNumber = (value, decimals) => {
            return (typeof value === 'number' && !isNaN(value)) ? value.toFixed(decimals) : 'N/A';
        };

        async function fetchSignals() {
            showLoading();
            try {
                const githubUrl = 'https://raw.githubusercontent.com/ApexStrikeLive/my-web/main/traced_signals.json';
                console.log("Attempting to fetch data from:", githubUrl);
                const response = await fetch(githubUrl);
                console.log("Fetch response status:", response.status);

                let fetchedData = [];
                if (response.ok) {
                    fetchedData = await response.json();
                    console.log("Fetched data. Number of signals:", fetchedData.length);
                } else {
                    console.error(`HTTP error fetching data! status: ${response.status}`);
                    console.warn(`Could not fetch data from GitHub. The dashboard might appear empty until a successful fetch.`);
                    return [];
                }

                // We no longer fetch live prices or calculate PnL for individual signals
                // as those details are removed from the display.
                // However, we need 'profit_loss_percentage' and 'realized_pnl' for closed signals
                // to correctly calculate successful/unsuccessful counts.
                // Assuming these are present in your traced_signals.json for closed signals.

                currentSignalsData = fetchedData; // Use fetched data directly
                return currentSignalsData;

            } catch (error) {
                console.error("General error in fetchSignals:", error);
                return [];
            } finally {
                hideLoading();
            }
        }

        /**
         * Updates the summary statistics at the top of the page, including new detailed metrics.
         * @param {Array<Object>} signals - The array of all signal objects.
         */
        function updateSummaryStatistics(signals) {
            const totalSignals = signals.length;
            let successfulSignals = 0;
            let closedUnsuccessfulSignals = 0;
            let openSignals = 0;
            let totalClosed100Percent = 0;
            let closedSLLossGreaterThan3 = 0;

            signals.forEach(signal => {
                if (signal.monitoring_status === "OPEN") {
                    openSignals++;
                } else if (signal.monitoring_status && signal.monitoring_status.includes("CLOSED")) {
                    // Check if realized_pnl is a number before comparison
                    if (typeof signal.realized_pnl === 'number') {
                        if (signal.realized_pnl > 0) {
                            successfulSignals++;
                        } else { // realized_pnl is 0 or negative
                            closedUnsuccessfulSignals++;
                        }
                    } else {
                        // If realized_pnl is not a valid number for a closed signal, count as unsuccessful
                        closedUnsuccessfulSignals++;
                    }
                }

                // Total Closed 100%
                if (typeof signal.closed_percentage === 'number' && signal.closed_percentage === 100 && signal.monitoring_status && signal.monitoring_status.includes('CLOSED')) {
                    totalClosed100Percent++;
                }

                // Closed SL (Loss > -3%)
                // Counts signals closed by SL with a loss greater than 3% (e.g., -3.1%, -5%)
                if (signal.monitoring_status && signal.monitoring_status.includes("CLOSED_SL") &&
                    typeof signal.profit_loss_percentage === 'number' && signal.profit_loss_percentage < -3) {
                    closedSLLossGreaterThan3++;
                }
            });

            document.getElementById('totalSignals').textContent = totalSignals;
            document.getElementById('successfulSignals').textContent = successfulSignals;
            document.getElementById('closedUnsuccessfulSignals').textContent = closedUnsuccessfulSignals;
            document.getElementById('openSignals').textContent = openSignals;
            document.getElementById('totalClosed100Percent').textContent = totalClosed100Percent;
            document.getElementById('closedSLLossGreaterThan3').textContent = closedSLLossGreaterThan3;
            console.log("Summary Statistics Updated:", { totalSignals, successfulSignals, closedUnsuccessfulSignals, openSignals, totalClosed100Percent, closedSLLossGreaterThan3 });
        }


        /**
         * Renders detailed statistics grouped by strategy name,
         * including Total, Successful, Unsuccessful, Open, Closed 100%, and Closed SL (Loss > -3%).
         * @param {Array<Object>} signals - The array of all signal objects.
         */
        function renderStrategyStatistics(signals) {
            const strategyContainer = document.getElementById('strategyStatisticsContainer');
            strategyContainer.innerHTML = ''; // Clear previous content

            const strategyStats = {};

            signals.forEach(signal => {
                // Ensure strategy_name is correctly accessed; default to 'Uncategorized' if missing
                const strategyName = signal.strategy_name || 'Uncategorized';

                if (!strategyStats[strategyName]) {
                    strategyStats[strategyName] = {
                        totalSignals: 0,
                        successfulSignals: 0,
                        unsuccessfulSignals: 0,
                        openSignals: 0,
                        totalClosed100Percent: 0,
                        closedSLLossGreaterThan3: 0
                    };
                }

                strategyStats[strategyName].totalSignals++;

                if (signal.monitoring_status === "OPEN") {
                    strategyStats[strategyName].openSignals++;
                } else if (signal.monitoring_status && signal.monitoring_status.includes('CLOSED')) {
                    if (typeof signal.realized_pnl === 'number') {
                        if (signal.realized_pnl > 0) {
                            strategyStats[strategyName].successfulSignals++;
                        } else {
                            strategyStats[strategyName].unsuccessfulSignals++;
                        }
                    } else {
                        // If realized_pnl is missing or invalid for a closed signal, count as unsuccessful
                        strategyStats[strategyName].unsuccessfulSignals++;
                    }

                    // Calculate Total Closed 100% for the strategy
                    if (typeof signal.closed_percentage === 'number' && signal.closed_percentage === 100) {
                        strategyStats[strategyName].totalClosed100Percent++;
                    }

                    // Calculate Closed SL (Loss > -3%) for the strategy
                    if (signal.monitoring_status.includes("CLOSED_SL") &&
                        typeof signal.profit_loss_percentage === 'number' && signal.profit_loss_percentage < -3) {
                        strategyStats[strategyName].closedSLLossGreaterThan3++;
                    }
                }
            });

            // Sort strategies by totalSignals in descending order
            const sortedStrategyNames = Object.keys(strategyStats).sort((a, b) => {
                return strategyStats[b].totalSignals - strategyStats[a].totalSignals;
            });

            if (sortedStrategyNames.length === 0) {
                strategyContainer.innerHTML = '<p class="text-gray-600 col-span-full">No strategy statistics available.</p>';
                console.log("No strategy statistics to render.");
            } else {
                sortedStrategyNames.forEach(name => {
                    const stats = strategyStats[name];
                    const strategyCard = document.createElement('div');
                    strategyCard.className = 'strategy-card';
                    strategyCard.innerHTML = `
                        <h3 class="mb-2">${name}</h3>
                        <p><strong>Total Signals:</strong> ${stats.totalSignals}</p>
                        <p><strong>Successful:</strong> <span class="text-green-600 font-semibold">${stats.successfulSignals}</span></p>
                        <p><strong>Unsuccessful:</strong> <span class="text-red-600 font-semibold">${stats.unsuccessfulSignals}</span></p>
                        <p><strong>Open:</strong> <span class="text-blue-600 font-semibold">${stats.openSignals}</span></p>
                        <p><strong>Closed 100%:</strong> <span class="text-purple-600 font-semibold">${stats.totalClosed100Percent}</span></p>
                        <p><strong>Closed SL (Loss &lt; -3%):</strong> <span class="text-orange-600 font-semibold">${stats.closedSLLossGreaterThan3}</span></p>
                    `;
                    strategyContainer.appendChild(strategyCard);
                });
                console.log("Strategy Statistics Rendered:", strategyStats);
            }
        }

        // Initial fetch and render
        document.addEventListener('DOMContentLoaded', async () => {
            const signals = await fetchSignals();
            updateSummaryStatistics(signals);
            renderStrategyStatistics(signals); // Call the new function here

            // Set up interval for refreshing data every 5 minutes (300000 milliseconds)
            setInterval(async () => {
                const updatedSignals = await fetchSignals();
                updateSummaryStatistics(updatedSignals);
                renderStrategyStatistics(updatedSignals); // Refresh strategy stats
            }, 300000);
        });
    </script>
</body>
</html>
