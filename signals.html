<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Signals</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #334155; /* Darker text color */
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* Light gray border */
        }
        th {
            background-color: #f8fafc; /* Lighter header background */
            font-weight: 600;
            color: #475569; /* Slightly darker header text */
        }
        tr:hover {
            background-color: #f1f5f9; /* Lighter hover effect */
        }
        .signal-card {
            border: 1px solid #cbd5e1; /* Gray border */
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .signal-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .signal-card-body {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .signal-card-item {
            display: flex;
            flex-direction: column;
        }
        .signal-card-item strong {
            color: #1e293b; /* Darker label */
        }
        .chart-container {
            margin-top: 1.5rem;
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
            /* Ensure the container has a defined height for TradingView widget */
            height: 400px; /* Set a default height */
            overflow: hidden; /* Hide overflow if widget is larger */
        }
        .buy-signal {
            color: #10b981; /* Green for BUY */
            font-weight: bold;
        }
        .sell-signal {
            color: #ef4444; /* Red for SELL */
            font-weight: bold;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Styles for the "Latest Signals" section */
        .latest-signals-section {
            background-color: #e0f2fe; /* Light blue */
            border: 1px solid #90cdf4; /* Medium blue border */
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .latest-signals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .latest-signal-item {
            background-color: #ffffff;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 0.95rem;
        }
        .latest-signal-item strong {
            color: #334155;
        }

        /* Styles for Strategy Statistics */
        .strategy-statistics-section {
            background-color: #e6fffa; /* Light teal */
            border: 1px solid #81e6d9; /* Medium teal border */
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        .strategy-card {
            background-color: #ffffff;
            border: 1px solid #a7d9d5; /* Light teal border */
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .strategy-card h3 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #008080; /* Dark teal */
            margin-bottom: 1rem;
        }
        .strategy-card p {
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        .strategy-card p strong {
            color: #2c3e50; /* Darker text */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <h1 class="text-4xl font-extrabold text-center text-blue-700 mb-8">Trade Signals Dashboard</h1>

        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6 p-4 bg-blue-50 rounded-lg shadow-sm text-center">
            <div class="p-3 bg-white rounded-md shadow-sm">
                <p class="text-lg font-medium text-blue-700">Total Signals:</p>
                <p id="totalSignals" class="text-2xl font-bold text-gray-900">0</p>
            </div>
            <div class="p-3 bg-white rounded-md shadow-sm">
                <p class="text-lg font-medium text-blue-700">Successful Signals:</p>
                <p id="successfulSignals" class="text-2xl font-bold text-green-600">0</p>
            </div>
            <div class="p-3 bg-white rounded-md shadow-sm">
                <p class="text-lg font-medium text-blue-700">Unsuccessful Signals:</p>
                <p id="closedUnsuccessfulSignals" class="text-2xl font-bold text-red-600">0</p>
            </div>
            <div class="p-3 bg-white rounded-md shadow-sm">
                <p class="text-lg font-medium text-blue-700">Open Signals:</p>
                <p id="openSignals" class="text-2xl font-bold text-blue-600">0</p>
            </div>
            <div class="p-3 bg-white rounded-md shadow-sm">
                <p class="text-lg font-medium text-blue-700">Total Closed 100%:</p>
                <p id="totalClosed100Percent" class="text-2xl font-bold text-purple-600">0</p>
            </div>
            <div class="p-3 bg-white rounded-md shadow-sm">
                <p class="text-lg font-medium text-blue-700">Closed SL (Loss > -3%):</p>
                <p id="closedSLLossGreaterThan3" class="text-2xl font-bold text-orange-600">0</p>
            </div>
        </div>

        <div class="latest-signals-section">
            <h2 class="text-2xl font-bold text-blue-700 mb-4">Latest Signals (Last Hour)</h2>
            <div id="latestSignalsContainer" class="latest-signals-grid">
                <p class="text-gray-600 col-span-full">No new signals in the last hour.</p>
            </div>
        </div>

        <div class="strategy-statistics-section">
            <h2 class="text-2xl font-bold text-teal-700 mb-4">Statistics by Strategy</h2>
            <div id="strategyStatisticsContainer" class="strategy-grid">
                <p class="text-gray-600 col-span-full">No strategy statistics available.</p>
            </div>
        </div>

        <div id="signalsContainer" class="mt-8">
            </div>
    </div>

    <script>
        let currentSignalsData = []; 

        const tpLevelsDefinition = [
            { level: 0.7, close_percentage: 25, sl_profit_net: 0.0 },
            { level: 0.8, close_percentage: 0, sl_profit_net: 0.2 },
            { level: 1.2, close_percentage: 25, sl_profit_net: 0.6 },
            { level: 1.5, close_percentage: 0, sl_profit_net: 0.8 },
            { level: 1.8, close_percentage: 0, sl_profit_net: 1.0 },
            { level: 2.0, close_percentage: 25, sl_profit_net: 1.4 },
            { level: 2.4, close_percentage: 0, sl_profit_net: 1.6 },
            { level: 2.6, close_percentage: 0, sl_profit_net: 1.8 },
            { level: 2.8, close_percentage: 0, sl_profit_net: 2.0 },
            { level: 3.0, close_percentage: 0, sl_profit_net: 2.5 },
            { level: 3.3, close_percentage: 100, sl_profit_net: null }
        ];

        let charts = {}; 

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        const formatNumber = (value, decimals) => {
            return (typeof value === 'number' && !isNaN(value)) ? value.toFixed(decimals) : 'N/A';
        };

        async function fetchSignals() {
            showLoading();
            try {
                const githubUrl = 'https://raw.githubusercontent.com/ApexStrikeLive/my-web/main/traced_signals.json';
                console.log("Attempting to fetch historical data from:", githubUrl);
                const response = await fetch(githubUrl);
                console.log("Historical data fetch response status:", response.status);

                let fetchedData = [];
                if (response.ok) {
                    fetchedData = await response.json();
                    console.log("Fetched historical data:", fetchedData);
                } else {
                    console.error(`HTTP error fetching historical data! status: ${response.status}`);
                    console.warn(`Could not fetch historical data from GitHub. The dashboard might appear empty until a successful fetch.`);
                    return []; 
                }

                const mergedData = {};
                fetchedData.forEach(signal => mergedData[signal.signal_id] = signal);

                const coinGeckoIdMap = {
                    "BTC": "bitcoin", "ETH": "ethereum", "ADA": "cardano", "CVX": "convex-finance",
                    "APT": "aptos", "METIS": "metisdao", "GAS": "gas", "SSV": "ssv-network",
                    "AAVE": "aave", "LINK": "chainlink", "SOL": "solana", "BNB": "binancecoin"
                    // Add more mappings as needed
                };

                const symbolsToFetch = new Set();
                Object.values(mergedData).forEach(signal => {
                    const baseSymbol = signal.symbol ? signal.symbol.split('/')[0] : null; 
                    if (baseSymbol && coinGeckoIdMap[baseSymbol]) {
                        symbolsToFetch.add(coinGeckoIdMap[baseSymbol]);
                    }
                });

                if (symbolsToFetch.size > 0) {
                    const ids = Array.from(symbolsToFetch).join(',');
                    const vsCurrencies = 'usdt'; 
                    const livePriceUrl = `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=${vsCurrencies}`;
                    console.log("Attempting to fetch live prices from:", livePriceUrl);

                    try {
                        const priceResponse = await fetch(livePriceUrl);
                        console.log("Live price fetch response status:", priceResponse.status);
                        if (priceResponse.ok) {
                            const livePrices = await priceResponse.json();
                            console.log("Fetched live prices:", livePrices);

                            Object.values(mergedData).forEach(signal => {
                                const baseSymbol = signal.symbol ? signal.symbol.split('/')[0] : null; 
                                const coinGeckoId = baseSymbol ? coinGeckoIdMap[baseSymbol] : null;
                                if (coinGeckoId && livePrices[coinGeckoId] && livePrices[coinGeckoId][vsCurrencies]) {
                                    const newCurrentPrice = livePrices[coinGeckoId][vsCurrencies];
                                    signal.current_price = newCurrentPrice;

                                    if (signal.monitoring_status === 'OPEN' && typeof signal.entry_price === 'number' && signal.entry_price !== 0) {
                                        if (signal.signal_type === 'BUY') {
                                            signal.profit_loss_percentage = ((newCurrentPrice - signal.entry_price) / signal.entry_price) * 100;
                                            signal.unrealized_pnl = (newCurrentPrice - signal.entry_price) * (signal.initial_investment / signal.entry_price);
                                        } else if (signal.signal_type === 'SELL') {
                                            signal.profit_loss_percentage = ((signal.entry_price - newCurrentPrice) / signal.entry_price) * 100;
                                            signal.unrealized_pnl = (signal.entry_price - newCurrentPrice) * (signal.initial_investment / signal.entry_price);
                                        }
                                    } else if (signal.monitoring_status && signal.monitoring_status.startsWith('CLOSED')) {
                                        signal.unrealized_pnl = 0;
                                        if (typeof signal.realized_pnl === 'number' && typeof signal.initial_investment === 'number' && signal.initial_investment !== 0) {
                                            signal.profit_loss_percentage = (signal.realized_pnl / signal.initial_investment) * 100;
                                        } else {
                                            signal.profit_loss_percentage = 0; 
                                        }
                                    }
                                }
                            });
                        } else {
                            console.warn(`Could not fetch live prices from CoinGecko (status: ${priceResponse.status}).`);
                        }
                    } catch (priceError) {
                        console.error("Error fetching live prices from CoinGecko:", priceError);
                    }
                } else {
                    console.log("No symbols found in the data to fetch live prices for.");
                }

                currentSignalsData = Object.values(mergedData); 
                return currentSignalsData;

            } catch (error) {
                console.error("General error in fetchSignals:", error);
                return []; 
            } finally {
                hideLoading();
            }
        }

        /**
         * Updates the summary statistics at the top of the page, including new detailed metrics.
         * @param {Array<Object>} signals - The array of all signal objects.
         */
        function updateSummaryStatistics(signals) {
            const totalSignals = signals.length;
            let successfulSignals = 0; 
            let closedUnsuccessfulSignals = 0; // This will now count "CLOSED_SL" regardless of P&L for "Unsuccessful Signals" overall.
            let openSignals = 0; 
            let totalClosed100Percent = 0; 
            let closedSLLossGreaterThan3 = 0; 

            signals.forEach(signal => {
                // Total Signals: already handled by signals.length

                // Open Signals
                if (signal.monitoring_status === "OPEN") {
                    openSignals++;
                }

                // Successful Signals: based on realized_pnl for CLOSED signals
                if (signal.monitoring_status && signal.monitoring_status.includes("CLOSED") && typeof signal.realized_pnl === 'number' && signal.realized_pnl > 0) {
                    successfulSignals++;
                }

                // Unsuccessful Signals: based on being CLOSED_SL or CLOSED and P&L <= 0
                if (signal.monitoring_status && signal.monitoring_status.includes("CLOSED_SL") && typeof signal.realized_pnl === 'number' && signal.realized_pnl <= 0) {
                    closedUnsuccessfulSignals++;
                }
                // Alternative interpretation for Unsuccessful: if monitoring_status contains "CLOSED" and realized_pnl is 0 or negative
                // if (signal.monitoring_status && signal.monitoring_status.includes("CLOSED") && typeof signal.realized_pnl === 'number' && signal.realized_pnl <= 0) {
                //     // Ensure it's not already counted as successful
                //     if (signal.realized_pnl <= 0) {
                //         closedUnsuccessfulSignals++;
                //     }
                // }


                // Total Closed 100%
                if (typeof signal.closed_percentage === 'number' && signal.closed_percentage === 100 && signal.monitoring_status && signal.monitoring_status.includes('CLOSED')) {
                    totalClosed100Percent++;
                }

                // Closed SL (Loss > -3%)
                // This will count signals that were closed by SL and had a profit_loss_percentage less than -3 (e.g., -3.1%, -5%, meaning a larger loss)
                if (signal.monitoring_status && signal.monitoring_status.includes("CLOSED_SL") && typeof signal.profit_loss_percentage === 'number' && signal.profit_loss_percentage < -3) {
                    closedSLLossGreaterThan3++;
                }
            });

            document.getElementById('totalSignals').textContent = totalSignals;
            document.getElementById('successfulSignals').textContent = successfulSignals;
            document.getElementById('closedUnsuccessfulSignals').textContent = closedUnsuccessfulSignals;
            document.getElementById('openSignals').textContent = openSignals;
            document.getElementById('totalClosed100Percent').textContent = totalClosed100Percent;
            document.getElementById('closedSLLossGreaterThan3').textContent = closedSLLossGreaterThan3;
        }

        /**
         * Creates and renders a TradingView chart for a given signal.
         * (This function remains unchanged from previous versions.)
         */
        function createChart(signal, containerId) {
            const chartContainer = document.getElementById(containerId);
            chartContainer.innerHTML = ''; 

            const [base, quote] = signal.symbol.split('/');
            const tradingViewSymbol = `BINANCE:${base}${quote}`; 

            const innerWidgetId = `tradingview_widget_${signal.signal_id}`;

            let tvInterval = "D"; 
            if (signal.timeframe && signal.timeframe.includes('m')) {
                tvInterval = signal.timeframe.replace('m', ''); 
            } else if (signal.timeframe && signal.timeframe.includes('h')) {
                tvInterval = signal.timeframe.replace('h', 'H'); 
            } else if (signal.timeframe === 'DAILY') {
                tvInterval = "D";
            }

            const widgetWrapper = document.createElement('div');
            widgetWrapper.className = 'tradingview-widget-container';
            widgetWrapper.style.height = '100%';
            widgetWrapper.style.width = '100%';

            const innerWidgetDiv = document.createElement('div');
            innerWidgetDiv.id = innerWidgetId;
            innerWidgetDiv.className = 'tradingview-widget-container__widget';
            innerWidgetDiv.style.height = 'calc(100% - 32px)';
            innerWidgetDiv.style.width = '100%';

            const copyrightDiv = document.createElement('div');
            copyrightDiv.className = 'tradingview-widget-copyright';
            copyrightDiv.innerHTML = `<a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank"><span class="blue-text">Track all markets on TradingView</span></a>`;

            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
            script.async = true;

            const widgetConfig = {
                "width": "100%",
                "height": "400", 
                "symbol": tradingViewSymbol,
                "interval": tvInterval,
                "timezone": "Etc/UTC",
                "theme": "light", 
                "style": "1", 
                "locale": "en",
                "toolbar_bg": "#f1f5f9", 
                "enable_publishing": false,
                "allow_symbol_change": true,
                "container_id": innerWidgetId, 
                "hide_side_toolbar": false,
                "hide_top_toolbar": false,
                "withdateranges": true,
                "save_image": false,
                "details": false,
                "hotlist": false,
                "calendar": false,
                "studies": ["RSI@tv-basicstudies", "MACD@tv-basicstudies"], 
                "show_popup_button": true,
                "popup_width": "1000",
                "popup_height": "650",
            };

            script.textContent = JSON.stringify(widgetConfig);

            widgetWrapper.appendChild(innerWidgetDiv);
            widgetWrapper.appendChild(copyrightDiv);
            widgetWrapper.appendChild(script); 

            chartContainer.appendChild(widgetWrapper);

            charts[signal.signal_id] = chartContainer;
        }

        /**
         * Renders the top 5 latest signals added within the last hour.
         * (This function remains unchanged from previous versions.)
         */
        function renderLatestSignals(signals) {
            const latestSignalsContainer = document.getElementById('latestSignalsContainer');
            latestSignalsContainer.innerHTML = ''; 

            const now = new Date(); 
            const oneHourAgo = new Date(now.getTime() - (60 * 60 * 1000)); 

            const latestSignals = signals.filter(signal => {
                try {
                    const entryTime = new Date(signal.entry_time);
                    // Check if entryTime is a valid date AND if it's after oneHourAgo
                    return !isNaN(entryTime.getTime()) && entryTime > oneHourAgo;
                } catch (e) {
                    console.warn("Invalid entry_time for signal:", signal.signal_id, signal.entry_time, e);
                    return false; 
                }
            })
            .sort((a, b) => new Date(b.entry_time) - new Date(a.entry_time)) 
            .slice(0, 5); 

            if (latestSignals.length === 0) {
                latestSignalsContainer.innerHTML = '<p class="text-gray-600 col-span-full">No new signals in the last hour.</p>';
            } else {
                latestSignals.forEach(signal => {
                    const signalTypeClass = signal.signal_type === 'BUY' ? 'buy-signal' : 'sell-signal';
                    const signalItem = document.createElement('div');
                    signalItem.className = 'latest-signal-item';
                    signalItem.innerHTML = `
                        <p class="font-bold text-lg">${signal.symbol || 'N/A'} <span class="${signalTypeClass}">(${signal.signal_type || 'N/A'})</span></p>
                        <p><strong>Entry:</strong> ${formatNumber(signal.entry_price, 4)}</p>
                        <p><strong>Time:</strong> ${signal.entry_time ? new Date(signal.entry_time).toLocaleTimeString() : 'N/A'}</p>
                        <p><strong>P/L%:</strong> <span class="${(typeof signal.profit_loss_percentage === 'number' && !isNaN(signal.profit_loss_percentage)) ? (signal.profit_loss_percentage >= 0 ? 'text-green-600' : 'text-red-600') : ''}">${formatNumber(signal.profit_loss_percentage, 2)}%</span></p>
                    `;
                    latestSignalsContainer.appendChild(signalItem);
                });
            }
        }

        /**
         * Renders statistics grouped by strategy name.
         * @param {Array<Object>} signals - The array of all signal objects.
         */
        function renderStrategyStatistics(signals) {
            const strategyContainer = document.getElementById('strategyStatisticsContainer');
            strategyContainer.innerHTML = ''; // Clear previous content

            const strategyStats = {};

            signals.forEach(signal => {
                const strategyName = signal.strategy_name || 'Uncategorized'; // Default for signals without a strategy

                if (!strategyStats[strategyName]) {
                    strategyStats[strategyName] = {
                        totalSignals: 0,
                        successfulSignals: 0,
                        unsuccessfulSignals: 0,
                        openSignals: 0
                    };
                }

                strategyStats[strategyName].totalSignals++;

                if (signal.monitoring_status === "OPEN") {
                    strategyStats[strategyName].openSignals++;
                } else if (signal.monitoring_status && signal.monitoring_status.includes('CLOSED')) { // Check if it's a closed signal
                    // Ensure realized_pnl is a number before comparison
                    if (typeof signal.realized_pnl === 'number') {
                        if (signal.realized_pnl > 0) {
                            strategyStats[strategyName].successfulSignals++;
                        } else { // Consider any non-positive realized_pnl as unsuccessful for strategy stats
                            strategyStats[strategyName].unsuccessfulSignals++;
                        }
                    } else {
                        // If realized_pnl is missing or invalid for a closed signal, default to unsuccessful
                        strategyStats[strategyName].unsuccessfulSignals++;
                    }
                }
            });

            const strategyNames = Object.keys(strategyStats).sort(); // Sort strategy names alphabetically

            if (strategyNames.length === 0) {
                strategyContainer.innerHTML = '<p class="text-gray-600 col-span-full">No strategy statistics available.</p>';
            } else {
                strategyNames.forEach(name => {
                    const stats = strategyStats[name];
                    const strategyCard = document.createElement('div');
                    strategyCard.className = 'strategy-card';
                    strategyCard.innerHTML = `
                        <h3 class="mb-2">${name}</h3>
                        <p><strong>Total Signals:</strong> ${stats.totalSignals}</p>
                        <p><strong>Successful:</strong> <span class="text-green-600 font-semibold">${stats.successfulSignals}</span></p>
                        <p><strong>Unsuccessful:</strong> <span class="text-red-600 font-semibold">${stats.unsuccessfulSignals}</span></p>
                        <p><strong>Open:</strong> <span class="text-blue-600 font-semibold">${stats.openSignals}</span></p>
                    `;
                    strategyContainer.appendChild(strategyCard);
                });
            }
        }


        /**
         * Renders the signals data into the HTML, grouped by date.
         * (This function remains largely unchanged, but now renders after new stats sections.)
         * @param {Array<Object>} signals - The array of signal objects.
         */
        function renderSignals(signals) {
            const signalsContainer = document.getElementById('signalsContainer');
            signalsContainer.innerHTML = ''; 

            for (const id in charts) {
                if (charts[id]) {
                    charts[id].innerHTML = ''; 
                    charts[id] = null; 
                }
            }
            charts = {}; 

            const sortedSignals = [...signals].sort((a, b) => new Date(b.entry_time) - new Date(a.entry_time));

            const signalsByDate = sortedSignals.reduce((acc, signal) => {
                const entryTime = signal.entry_time ? new Date(signal.entry_time) : null;
                const date = entryTime ? entryTime.toISOString().split('T')[0] : 'Unknown Date'; 
                if (!acc[date]) {
                    acc[date] = [];
                }
                acc[date].push(signal);
                return acc;
            }, {});

            const now = new Date();
            const today = now.toISOString().split('T')[0];

            for (const date in signalsByDate) {
                const isToday = date === today;
                const detailsElement = document.createElement('details');
                detailsElement.className = 'mb-4';
                if (isToday) {
                    detailsElement.setAttribute('open', ''); 
                }

                const summaryElement = document.createElement('summary');
                summaryElement.className = 'bg-blue-200 p-4 rounded-t-lg cursor-pointer font-semibold text-xl text-blue-800 hover:bg-blue-300 transition duration-200';
                summaryElement.textContent = `Signals for ${date}`;
                if (isToday) {
                    summaryElement.textContent += ' (Today)';
                }
                detailsElement.appendChild(summaryElement);

                const dateSignalsDiv = document.createElement('div');
                dateSignalsDiv.className = 'p-4 border border-t-0 border-blue-200 rounded-b-lg bg-white';

                const signalsForDate = signalsByDate[date];

                if (signalsForDate.length === 0) {
                    dateSignalsDiv.innerHTML = '<p class="text-center text-gray-600">No signals for this date.</p>';
                } else {
                    signalsForDate.forEach(signal => {
                        const signalCard = document.createElement('div');
                        signalCard.className = 'signal-card';
                        signalCard.id = `signal-${signal.signal_id}`;

                        const signalTypeClass = signal.signal_type === 'BUY' ? 'buy-signal' : 'sell-signal';

                        signalCard.innerHTML = `
                            <div class="signal-card-header">
                                <h2 class="text-2xl font-bold text-gray-900">${signal.symbol || 'N/A'} <span class="${signalTypeClass}">(${signal.signal_type || 'N/A'})</span></h2>
                                <button class="toggle-chart-btn px-4 py-2 bg-purple-600 text-white rounded-md shadow-sm hover:bg-purple-700 transition duration-200" data-signal-id="${signal.signal_id}">
                                    Show Chart
                                </button>
                            </div>
                            <div class="signal-card-body">
                                <div class="signal-card-item"><strong>Timeframe:</strong> <span>${signal.timeframe || 'N/A'}</span></div>
                                <div class="signal-card-item"><strong>Entry Price:</strong> <span>${formatNumber(signal.entry_price, 4)}</span></div>
                                <div class="signal-card-item"><strong>Entry Time:</strong> <span>${signal.entry_time ? new Date(signal.entry_time).toLocaleString() : 'N/A'}</span></div>
                                <div class="signal-card-item"><strong>Monitoring Status:</strong> <span>${signal.monitoring_status || 'N/A'}</span></div>
                                <div class="signal-card-item"><strong>Current Price:</strong> <span>${formatNumber(signal.current_price, 4)}</span></div>
                                <div class="signal-card-item"><strong>Profit/Loss %:</strong> <span class="${(typeof signal.profit_loss_percentage === 'number' && !isNaN(signal.profit_loss_percentage)) ? (signal.profit_loss_percentage >= 0 ? 'text-green-600' : 'text-red-600') : ''}">${formatNumber(signal.profit_loss_percentage, 2)}%</span></div>
                                <div class="signal-card-item"><strong>Realized PnL:</strong> <span>${formatNumber(signal.realized_pnl, 2)}</span></div>
                                <div class="signal-card-item"><strong>Unrealized PnL:</strong> <span>${formatNumber(signal.unrealized_pnl, 2)}</span></div>
                                <div class="signal-card-item"><strong>Stop Loss Price:</strong> <span>${formatNumber(signal.stop_loss_price, 4)}</span></div>
                                <div class="signal-card-item"><strong>Take Profit Target:</strong> <span>${formatNumber(signal.take_profit_target, 4)}</span></div>
                                <div class="signal-card-item"><strong>Closed Percentage:</strong> <span>${formatNumber(signal.closed_percentage, 2)}%</span></div>
                                <div class="signal-card-item"><strong>Exit Price:</strong> <span>${formatNumber(signal.exit_price, 4)}</span></div>
                                <div class="signal-card-item"><strong>Exit Time:</strong> <span>${signal.exit_time ? new Date(signal.exit_time).toLocaleString() : 'N/A'}</span></div>
                                <div class="signal-card-item"><strong>Notes:</strong> <span>${signal.notes || 'N/A'}</span></div>
                                <div class="signal-card-item"><strong>Strategy Name:</strong> <span>${signal.strategy_name || 'N/A'}</span></div>
                                <div class="signal-card-item"><strong>Initial Investment:</strong> <span>${formatNumber(signal.initial_investment, 2)}</span></div>
                                <div class="signal-card-item"><strong>Achieved 25% TP:</strong> <span>${signal.achieved_25_percent_tp ? 'Yes' : 'No'}</span></div>
                                <div class="signal-card-item"><strong>Achieved 50% TP:</strong> <span>${signal.achieved_50_percent_tp ? 'Yes' : 'No'}</span></div>
                                <div class="signal-card-item"><strong>TP Levels Activated:</strong> <span>${(signal.activated_tp_levels && signal.activated_tp_levels.length > 0) ? signal.activated_tp_levels.join(', ') : 'None'}</span></div>
                            </div>
                            <div id="chart-container-${signal.signal_id}" class="chart-container hidden">
                                </div>
                        `;
                        dateSignalsDiv.appendChild(signalCard);
                    });
                }
                detailsElement.appendChild(dateSignalsDiv);
                signalsContainer.appendChild(detailsElement);
            });

            document.querySelectorAll('.toggle-chart-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const signalId = event.target.dataset.signalId;
                    const chartContainer = document.getElementById(`chart-container-${signalId}`);
                    const signal = currentSignalsData.find(s => s.signal_id === signalId);

                    if (chartContainer.classList.contains('hidden')) {
                        chartContainer.classList.remove('hidden');
                        event.target.textContent = 'Hide Chart';
                        createChart(signal, `chart-container-${signalId}`);
                    } else {
                        chartContainer.classList.add('hidden');
                        event.target.textContent = 'Show Chart';
                        if (charts[signalId]) {
                            charts[signalId].innerHTML = '';
                            charts[signalId] = null; 
                        }
                    }
                });
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const signals = await fetchSignals();
            updateSummaryStatistics(signals); 
            renderLatestSignals(signals); 
            renderStrategyStatistics(signals); 
            renderSignals(signals); 

            setInterval(async () => {
                const updatedSignals = await fetchSignals();
                updateSummaryStatistics(updatedSignals); 
                renderLatestSignals(updatedSignals); 
                renderStrategyStatistics(updatedSignals); 
                renderSignals(updatedSignals); 
            }, 60000); 
        });
    </script>
</body>
</html>
