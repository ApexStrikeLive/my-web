<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KH5MTMWP5T"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-KH5MTMWP5T');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Signals Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Minimalist Global Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #334155;
            padding: 1rem;
        }
        .container {
            max-width: 1200px;
            margin: 1rem auto;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        h1 {
            font-size: 2rem;
            text-align: center;
            color: #1e40af;
            margin-bottom: 1.5rem;
        }

        /* Summary Statistics Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding: 0.75rem;
            background-color: #e0f2fe;
            border-radius: 0.25rem;
        }
        .stat-item {
            background-color: #ffffff;
            border-radius: 0.25rem;
            padding: 0.75rem;
            text-align: center;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .stat-item:hover {
             background-color: #fef3c7; /* Light gold background on hover */
        }
        .stat-item p {
            font-size: 0.875rem;
            font-weight: 500;
            color: #475569;
        }
        .stat-item span {
            font-size: 1.25rem;
            font-weight: bold;
        }
        .green-text { color: #16a34a; }
        .red-text { color: #dc2626; }
        .blue-text { color: #2563eb; }
        .purple-text { color: #9333ea; }
        .orange-text { color: #ea580c; }
        .yellow-text { color: #ca8a04; }

        /* Strategy Stats Styles */
        .strategy-stats-section {
            margin-top: 2rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: #f0f9ff;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.05);
        }
        .strategy-stats-section h2 {
            font-size: 1.5rem;
            color: #1e40af;
            margin-bottom: 1rem;
            text-align: center;
        }
        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }
        .strategy-card {
            background-color: #ffffff;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid #bfdbfe;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .strategy-card:hover {
            transform: translateY(-3px);
        }
        .strategy-card h3 {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 0.75rem;
            text-align: center;
            border-bottom: 1px dashed #e2e8f0;
            padding-bottom: 0.5rem;
        }
        .strategy-card p {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        .strategy-card p strong {
            color: #475569;
        }

        /* Date Section Styles */
        .date-section {
            margin-bottom: 1rem;
            border: 1px solid #bfdbfe;
            border-radius: 0.5rem;
            background-color: #ffffff;
        }
        .date-summary {
            background-color: #dbeafe;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem 0.5rem 0 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            color: #1e40af;
            display: block;
        }
        details[open] .date-summary {
            border-radius: 0.5rem 0.5rem 0 0;
        }

        /* Signal Card Styles (minimalist) */
        .signal-card {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 1rem;
        }
        .signal-card:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .signal-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 0.75rem;
            gap: 0.5rem;
        }
        .signal-header h2 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e293b;
            margin-right: auto;
        }
        .signal-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.5rem;
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
        }
        .signal-info-item strong {
            color: #475569;
            margin-right: 0.25rem;
        }
        .buy-signal-text { color: #10b981; font-weight: bold; }
        .sell-signal-text { color: #ef4444; font-weight: bold; }
        .status-open { background-color: #bfdbfe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .status-closed-successful { background-color: #dcfce7; color: #16a34a; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .status-closed-unsuccessful { background-color: #fee2e2; color: #dc2626; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .status-closed-sl { background-color: #fce7dcf5; color: #ea580c; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .status-unknown { background-color: #e2e8f0; color: #475569; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
        .new-signal-bg { background-color: #fef9c3; }

        /* New: Style for negative profit/loss background */
        .profit-loss-negative-background {
            background-color: #ffebeb;
            color: #cc0000;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: bold;
        }

        /* TradingView Chart Styles */
        .chart-container {
            margin-top: 1rem;
            background-color: #f8fafc;
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #e2e8f0;
            height: 350px;
            overflow: hidden;
            display: none;
            flex-direction: column;
        }
        .chart-container.active {
            display: flex;
        }
        .tradingview-widget-container__widget {
            flex-grow: 1;
            height: 100%;
        }
        .tradingview-widget-copyright {
            font-size: 0.7rem;
            color: #787b86;
            text-align: right;
            padding-top: 0.25rem;
        }
        .tradingview-widget-copyright a {
            color: #787b86;
            text-decoration: none;
        }
        .tradingview-widget-copyright a:hover {
            text-decoration: underline;
        }

        /* Chart Button specific style */
        .show-chart-button {
            padding: 0.25rem 0.75rem;
            background-color: #4a5568;
            color: white;
            border-radius: 0.25rem;
            border: none;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        .show-chart-button:hover {
            background-color: #2d3748;
        }

        /* === Modal Popup Styles === */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 1.5rem;
            border: 1px solid #888;
            width: 90%;
            max-width: 900px;
            border-radius: 0.5rem;
            position: relative;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
        }
        .modal-header h2 {
            font-size: 1.5rem;
            color: #1e40af;
            font-weight: bold;
        }
        .modal-body {
            overflow-y: auto;
            flex-grow: 1;
        }
        .close-button {
            color: #aaa;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Trade Signals Overview</h1>

        <div id="statsSection" class="stats-grid">
            <div class="stat-item" id="totalSignalsItem">
                <p>Total Signals:</p>
                <span id="totalSignals">0</span>
            </div>
            <div class="stat-item">
                <p>Successful:</p>
                <span id="successfulSignals" class="green-text">0</span>
            </div>
            <div class="stat-item">
                <p>Unsuccessful:</p>
                <span id="unsuccessfulSignals" class="red-text">0</span>
            </div>
            <div class="stat-item" id="openSignalsItem">
                <p>Open Signals:</p>
                <span id="openSignals" class="blue-text">0</span>
            </div>
            <div class="stat-item" id="openSignals5MinItem">
                <p>Open (Last 5 Min):</p>
                <span id="openSignals5Min" class="yellow-text">0</span>
            </div>
        </div>

        <div id="strategyStatsSection" class="strategy-stats-section hidden">
            <h2>Statistics by Strategy</h2>
            <div id="strategyStatsGrid" class="strategy-grid">
            </div>
        </div>

        <div id="signalsContainer">
            <p class="text-center text-gray-500 py-4">Loading signals...</p>
        </div>

        <div id="filteredSignalsContainer" style="display: none;">
        </div>

    </div>

    <div id="signalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-strategy-title">Strategy Signals</h2>
                <span class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <div id="modal-signals-container">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state and data variables
        let allSignalsData = [];
        let currentView = 'all_signals';

        // Utility functions for formatting numbers and percentages
        const formatValue = (value, type = 'number', decimals = 2) => {
            if (typeof value !== 'number' || isNaN(value)) return 'N/A';
            if (type === 'percentage') return `${value.toFixed(decimals)}%`;
            return value.toFixed(decimals);
        };

        const coinGeckoIdMap = {
            "BTC": "bitcoin", "ETH": "ethereum", "ADA": "cardano", "CVX": "convex-finance",
            "APT": "aptos", "METIS": "metisdao", "GAS": "gas", "SSV": "ssv-network",
            "AAVE": "aave", "LINK": "chainlink", "SOL": "solana", "BNB": "binancecoin",
            "ORDI": "ordi", "CYBER": "cyberconnect", "MOVR": "moonriver", "GNO": "gnosis",
            "LPT": "livepeer", "ATM": "atletico-madrid-fan-token", "DCR": "decred", "PSG": "paris-saint-germain-fan-token",
        };

        /**
         * Fetches signals data from GitHub and live prices from CoinGecko.
         */
        async function fetchSignals() {
            try {
                const githubUrl = 'https://raw.githubusercontent.com/ApexStrikeLive/my-web/main/traced_signals.json';
                console.log("Fetching historical data...");
                const response = await fetch(githubUrl);
                if (!response.ok) {
                    console.error(`Error fetching historical data! Status: ${response.status}`);
                    return [];
                }
                const fetchedData = await response.json();
                if (!Array.isArray(fetchedData) || fetchedData.length === 0) {
                    console.log("No signals found in the JSON data.");
                    return [];
                }
                console.log("Historical data fetched:", fetchedData.length, "signals.");
                const mergedData = fetchedData.reduce((acc, signal) => {
                    acc[signal.signal_id] = signal;
                    return acc;
                }, {});
                const symbolsToFetch = new Set(Object.values(mergedData)
                    .map(signal => signal.symbol?.split('/')[0])
                    .filter(Boolean)
                    .map(symbol => coinGeckoIdMap[symbol])
                    .filter(Boolean));
                if (symbolsToFetch.size > 0) {
                    const ids = Array.from(symbolsToFetch).join(',');
                    const vsCurrencies = 'usdt';
                    const livePriceUrl = `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=${vsCurrencies}`;
                    try {
                        console.log("Fetching live prices...");
                        const priceResponse = await fetch(livePriceUrl);
                        if (priceResponse.ok) {
                            const livePrices = await priceResponse.json();
                            Object.values(mergedData).forEach(signal => {
                                const baseSymbol = signal.symbol?.split('/')[0];
                                const coinGeckoId = baseSymbol ? coinGeckoIdMap[baseSymbol] : null;
                                if (coinGeckoId && livePrices[coinGeckoId] && livePrices[coinGeckoId][vsCurrencies]) {
                                    signal.current_price = livePrices[coinGeckoId][vsCurrencies];
                                    if (signal.monitoring_status === 'OPEN' && typeof signal.entry_price === 'number' && signal.entry_price !== 0) {
                                        const priceDiff = signal.signal_type === 'BUY' ? signal.current_price - signal.entry_price : signal.entry_price - signal.current_price;
                                        signal.unrealized_profit_loss_percentage = (priceDiff / signal.entry_price) * 100;
                                    } else if (signal.monitoring_status?.includes('CLOSED')) {
                                        if (typeof signal.realized_pnl === 'number' && typeof signal.initial_investment === 'number' && signal.initial_investment !== 0) {
                                            signal.profit_loss_percentage = (signal.realized_pnl / signal.initial_investment) * 100;
                                        } else {
                                            signal.profit_loss_percentage = 0;
                                        }
                                        signal.unrealized_profit_loss_percentage = 0;
                                    }
                                }
                            });
                        } else {
                            console.warn(`Could not fetch live prices (status: ${priceResponse.status}).`);
                        }
                    } catch (priceError) {
                        console.error("Error fetching live prices:", priceError);
                    }
                } else {
                    console.log("No symbols for live price fetching.");
                }
                return Object.values(mergedData);
            } catch (error) {
                console.error("General error in fetchSignals:", error);
                return [];
            }
        }

        /**
         * Updates the summary statistics at the top of the page.
         */
        function updateSummaryStatistics(signals) {
            const statsSection = document.getElementById('statsSection');
            const strategyStatsSection = document.getElementById('strategyStatsSection');
            const strategyStatsGrid = document.getElementById('strategyStatsGrid');

            if (signals.length === 0) {
                statsSection.style.display = 'none';
                strategyStatsSection.classList.add('hidden');
                return;
            }
            statsSection.style.display = 'grid';
            strategyStatsSection.classList.remove('hidden');

            const stats = {
                totalSignals: signals.length,
                successfulSignals: 0,
                unsuccessfulSignals: 0,
                openSignals: 0,
                openSignals5Min: 0,
                strategies: {}
            };

            const now = new Date();
            const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000);

            signals.forEach(signal => {
                const strategyName = signal.strategy_name || 'Unknown Strategy';
                if (!stats.strategies[strategyName]) {
                    stats.strategies[strategyName] = {
                        total: 0,
                        successful: 0,
                        unsuccessful: 0,
                        open: 0,
                    };
                }
                stats.strategies[strategyName].total++;
                if (signal.monitoring_status === "OPEN") {
                    stats.openSignals++;
                    stats.strategies[strategyName].open++;
                    const entryTime = new Date(signal.entry_time);
                    if (entryTime >= fiveMinutesAgo) {
                        stats.openSignals5Min++;
                    }
                } else if (signal.monitoring_status?.includes("CLOSED")) {
                    if (typeof signal.realized_pnl === 'number') {
                        if (signal.realized_pnl > 0) {
                            stats.successfulSignals++;
                            stats.strategies[strategyName].successful++;
                        } else {
                            stats.unsuccessfulSignals++;
                            stats.strategies[strategyName].unsuccessful++;
                        }
                    } else {
                        stats.unsuccessfulSignals++;
                        stats.strategies[strategyName].unsuccessful++;
                    }
                }
            });

            document.getElementById('totalSignals').textContent = stats.totalSignals;
            document.getElementById('successfulSignals').textContent = stats.successfulSignals;
            document.getElementById('unsuccessfulSignals').textContent = stats.unsuccessfulSignals;
            document.getElementById('openSignals').textContent = stats.openSignals;
            document.getElementById('openSignals5Min').textContent = stats.openSignals5Min;

            strategyStatsGrid.innerHTML = '';
            for (const strategyName in stats.strategies) {
                const strategy = stats.strategies[strategyName];
                const strategyTotalClosed = strategy.successful + strategy.unsuccessful;
                const strategyWinRate = strategyTotalClosed > 0 ? (strategy.successful / strategyTotalClosed) * 100 : 0;
                const strategyCardHtml = `
                    <div class="strategy-card" data-strategy-name="${strategyName}">
                        <h3>${strategyName}</h3>
                        <p><strong>Total Signals:</strong> ${strategy.total}</p>
                        <p><strong>Successful:</strong> <span class="green-text">${strategy.successful}</span></p>
                        <p><strong>Unsuccessful:</strong> <span class="red-text">${strategy.unsuccessful}</span></p>
                        <p><strong>Open:</strong> <span class="blue-text">${strategy.open}</span></p>
                        <p><strong>Win Rate:</strong> <span class="${strategyWinRate >= 50 ? 'green-text' : 'red-text'}">${formatValue(strategyWinRate, 'percentage', 2)}</span></p>
                    </div>
                `;
                strategyStatsGrid.insertAdjacentHTML('beforeend', strategyCardHtml);
            }
        }

        /**
         * Creates and renders a TradingView chart for a given signal.
         */
        function createChart(signal, containerId) {
            const chartContainer = document.getElementById(containerId);
            if (!chartContainer || !signal.symbol) {
                console.error(`Cannot create chart for signal ${signal?.signal_id || 'N/A'}: Container not found or symbol missing.`);
                if (chartContainer) chartContainer.innerHTML = '<p class="text-center text-gray-500">Chart not available (missing symbol).</p>';
                return;
            }
            chartContainer.innerHTML = '';
            const [base, quote] = signal.symbol.split('/');
            const tradingViewSymbol = `BINANCE:${base}${quote}`;
            let tvInterval = "D";
            if (signal.timeframe) {
                if (signal.timeframe.includes('m')) tvInterval = signal.timeframe.replace('m', '');
                else if (signal.timeframe.includes('h')) tvInterval = signal.timeframe.replace('h', 'H');
                else if (signal.timeframe === 'DAILY') tvInterval = "D";
            }
            const innerWidgetId = `tradingview_widget_${signal.signal_id}`;
            const widgetConfig = {
                "width": "100%", "height": "350", "symbol": tradingViewSymbol,
                "interval": tvInterval, "timezone": "Etc/UTC", "theme": "light", "style": "1",
                "locale": "en", "toolbar_bg": "#f1f5f9", "enable_publishing": false,
                "allow_symbol_change": true, "container_id": innerWidgetId,
                "hide_side_toolbar": false, "hide_top_toolbar": false, "withdateranges": true,
                "save_image": false, "details": false, "hotlist": false, "calendar": false,
                "studies": ["RSI@tv-basicstudies", "MACD@tv-basicstudies"],
                "show_popup_button": true, "popup_width": "1000", "popup_height": "650"
            };
            const tradingViewContainer = document.createElement('div');
            tradingViewContainer.className = 'tradingview-widget-container';
            tradingViewContainer.style = 'height:100%; width:100%;';
            tradingViewContainer.innerHTML = `
                <div id="${innerWidgetId}" class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%;"></div>
                <div class="tradingview-widget-copyright">
                    <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
                        <span class="blue-text">Track all markets on TradingView</span>
                    </a>
                </div>
            `;
            chartContainer.appendChild(tradingViewContainer);
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
            script.async = true;
            script.textContent = JSON.stringify(widgetConfig);
            tradingViewContainer.appendChild(script);
        }

        /**
         * Toggles the display of a chart for a given signal.
         */
        function toggleChartDisplay(signal, buttonElement) {
            const chartContainerId = `chart-${signal.signal_id}`;
            const chartContainer = document.getElementById(chartContainerId);
            if (!chartContainer) {
                console.error(`Chart container not found for signal ID: ${signal.signal_id}`);
                return;
            }
            if (chartContainer.classList.contains('active')) {
                chartContainer.classList.remove('active');
                buttonElement.textContent = 'Show Chart';
                chartContainer.innerHTML = '';
            } else {
                chartContainer.classList.add('active');
                buttonElement.textContent = 'Hide Chart';
                createChart(signal, chartContainerId);
            }
        }

        /**
         * Attaches event listeners for "Show Chart" buttons within a given container.
         * @param {HTMLElement} container The container to search for buttons.
         */
        function attachChartButtonListeners(container) {
            container.querySelectorAll('.show-chart-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const signalId = event.target.dataset.signalId;
                    const signal = allSignalsData.find(s => s.signal_id === signalId);
                    if (signal) {
                        toggleChartDisplay(signal, event.target);
                    }
                });
            });
        }

        /**
         * Renders all signals data into the main container, grouped by date.
         */
        function renderSignals() {
            const signalsContainer = document.getElementById('signalsContainer');
            signalsContainer.style.display = 'block';
            document.getElementById('filteredSignalsContainer').style.display = 'none';
            currentView = 'all_signals';

            if (allSignalsData.length === 0) {
                signalsContainer.innerHTML = '<p class="text-center text-gray-600 py-8 text-lg">No signals to display.</p>';
                return;
            }

            const sortedSignalsGlobally = [...allSignalsData].sort((a, b) => new Date(b.entry_time) - new Date(a.entry_time));
            const signalsByDate = sortedSignalsGlobally.reduce((acc, signal) => {
                const entryTime = signal.entry_time ? new Date(signal.entry_time) : null;
                const date = entryTime ? entryTime.toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-') : 'Unknown Date';
                (acc[date] = acc[date] || []).push(signal);
                return acc;
            }, {});

            const statusOrder = {
                "OPEN": 1, "CLOSED_SUCCESSFUL": 2, "PARTIALLY_CLOSED": 3,
                "CLOSED_SL": 4, "CLOSED_UNSUCCESSFUL": 5, "UNKNOWN": 99
            };

            let htmlContent = '';
            for (const date in signalsByDate) {
                const isToday = date === new Date().toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
                const summaryText = `Signals from ${date}${isToday ? ' (Today)' : ''}`;
                let dateSignalsHtml = '';
                const sortedDateSignals = signalsByDate[date].sort((a, b) => {
                    const orderA = statusOrder[a.monitoring_status || 'UNKNOWN'] || statusOrder.UNKNOWN;
                    const orderB = statusOrder[b.monitoring_status || 'UNKNOWN'] || statusOrder.UNKNOWN;
                    if (orderA !== orderB) return orderA - orderB;
                    const timeA = new Date(a.entry_time).getTime();
                    const timeB = new Date(b.entry_time).getTime();
                    return timeB - timeA;
                });
                sortedDateSignals.forEach(signal => {
                    dateSignalsHtml += createSignalCardHtml(signal);
                });
                htmlContent += `
                    <details class="date-section">
                        <summary class="date-summary">${summaryText}</summary>
                        <div class="p-4">${dateSignalsHtml}</div>
                    </details>
                `;
            }
            signalsContainer.innerHTML = htmlContent;
            attachChartButtonListeners(signalsContainer);
        }

        /**
         * Renders a list of signals into a container.
         * This function is now generalized to handle all filtered views.
         */
        function renderSignalList(signals, title, containerId, noSignalsMessage, extraCardClasses = '') {
            const signalsContainer = document.getElementById('signalsContainer');
            const filteredContainer = document.getElementById(containerId);
            filteredContainer.innerHTML = '';
            signalsContainer.style.display = 'none';
            filteredContainer.style.display = 'block';

            const headerHtml = `<h2 class="text-xl font-bold text-gray-800 mb-4 text-center">${title}</h2>`;
            filteredContainer.insertAdjacentHTML('beforeend', headerHtml);

            if (signals.length === 0) {
                filteredContainer.insertAdjacentHTML('beforeend', `<p class="text-center text-gray-600 py-8 text-lg">${noSignalsMessage}</p>`);
            } else {
                let cardsHtml = '';
                signals.forEach(signal => {
                    cardsHtml += createSignalCardHtml(signal, extraCardClasses);
                });
                filteredContainer.insertAdjacentHTML('beforeend', cardsHtml);
            }
            attachChartButtonListeners(filteredContainer);
        }

        /**
         * Filters and renders all open signals.
         */
        function renderAllOpenSignals() {
            const allOpenSignals = allSignalsData.filter(s => s.monitoring_status === 'OPEN')
                .sort((a, b) => new Date(b.entry_time) - new Date(a.entry_time));
            renderSignalList(allOpenSignals, 'All Open Signals', 'filteredSignalsContainer', 'No currently open signals.');
            currentView = 'all_open';
        }

        /**
         * Filters and renders open signals from the last 5 minutes.
         */
        function renderOpenSignalsLast5Min() {
            const now = new Date();
            const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000);
            const newOpenSignals = allSignalsData.filter(s => {
                if (s.monitoring_status === 'OPEN' && s.entry_time) {
                    return new Date(s.entry_time) >= fiveMinutesAgo;
                }
                return false;
            }).sort((a, b) => new Date(b.entry_time) - new Date(a.entry_time));
            renderSignalList(newOpenSignals, 'New Open Signals (Last 5 Minutes)', 'filteredSignalsContainer', 'No new open signals in the last 5 minutes.', 'new-signal-bg');
            currentView = '5_min_open';
        }

        /**
         * Renders signals inside the modal for a specific strategy.
         */
        function renderSignalsInModal(signals) {
            const modalSignalsContainer = document.getElementById('modal-signals-container');
            modalSignalsContainer.innerHTML = '';
            if (signals.length === 0) {
                modalSignalsContainer.innerHTML = '<p class="text-center text-gray-600 py-8 text-lg">No signals found for this strategy.</p>';
                return;
            }
            const sortedSignals = signals.sort((a, b) => {
                const statusA = a.monitoring_status || 'UNKNOWN';
                const statusB = b.monitoring_status || 'UNKNOWN';
                if (statusA === "OPEN" && statusB !== "OPEN") return -1;
                if (statusA !== "OPEN" && statusB === "OPEN") return 1;
                const timeA = new Date(a.entry_time).getTime();
                const timeB = new Date(b.entry_time).getTime();
                return timeB - timeA;
            });
            let modalCardsHtml = '';
            sortedSignals.forEach(signal => {
                modalCardsHtml += createSignalCardHtml(signal);
            });
            modalSignalsContainer.innerHTML = modalCardsHtml;
            attachChartButtonListeners(modalSignalsContainer);
        }

        /**
         * Helper function to create the HTML for a single signal card.
         */
        function createSignalCardHtml(signal, extraClasses = '') {
            const signalTypeClass = signal.signal_type === 'BUY' ? 'buy-signal-text' : 'sell-signal-text';
            const chartContainerId = `chart-${signal.signal_id}`;
            let statusClass = 'status-unknown';
            let statusText = signal.monitoring_status || 'N/A';
            if (signal.monitoring_status === 'OPEN') {
                statusClass = 'status-open';
            } else if (signal.monitoring_status === 'CLOSED_SUCCESSFUL') {
                statusClass = 'status-closed-successful';
                statusText = 'Closed (Successful)';
            } else if (signal.monitoring_status === 'CLOSED_UNSUCCESSFUL') {
                statusClass = 'status-closed-unsuccessful';
                statusText = 'Closed (Unsuccessful)';
            } else if (signal.monitoring_status === 'CLOSED_SL') {
                statusClass = 'status-closed-sl';
                statusText = 'Closed (Stop Loss)';
            } else if (signal.monitoring_status === 'PARTIALLY_CLOSED') {
                statusClass = 'status-closed-successful';
                statusText = 'Partially Closed';
            }
            let profitLossDisplay = 'N/A';
            let profitLossClass = '';
            if (signal.monitoring_status === 'OPEN' && typeof signal.unrealized_profit_loss_percentage === 'number') {
                profitLossDisplay = `${formatValue(signal.unrealized_profit_loss_percentage, 'percentage', 2)}`;
                profitLossClass = signal.unrealized_profit_loss_percentage >= 0 ? 'green-text' : 'red-text';
            } else if (signal.monitoring_status?.includes('CLOSED') && typeof signal.profit_loss_percentage === 'number') {
                profitLossDisplay = `${formatValue(signal.profit_loss_percentage, 'percentage', 2)}`;
                if (signal.monitoring_status === 'CLOSED_SL' && signal.profit_loss_percentage < 0) {
                    profitLossClass = 'profit-loss-negative-background';
                } else {
                    profitLossClass = signal.profit_loss_percentage >= 0 ? 'green-text' : 'red-text';
                }
            }
            return `
                <div class="signal-card ${extraClasses}" id="signal-${signal.signal_id}">
                    <div class="signal-header">
                        <h2>${signal.symbol || 'N/A'} <span class="${signalTypeClass}">(${signal.signal_type || 'N/A'})</span></h2>
                        <span class="${statusClass}">${statusText}</span>
                        <button class="show-chart-button" data-signal-id="${signal.signal_id}">Show Chart</button>
                    </div>
                    <div class="signal-info-grid">
                        <div class="signal-info-item"><strong>Strategy:</strong> <span>${signal.strategy_name || 'N/A'}</span></div>
                        <div class="signal-info-item"><strong>Entry Price:</strong> <span>${formatValue(signal.entry_price, 'number', 4)}</span></div>
                        <div class="signal-info-item"><strong>Current Price:</strong> <span>${formatValue(signal.current_price, 'number', 4)}</span></div>
                        <div class="signal-info-item"><strong>Stop Loss:</strong> <span>${formatValue(signal.stop_loss_price, 'number', 4)}</span></div>
                        <div class="signal-info-item"><strong>Profit/Loss:</strong> <span class="${profitLossClass}">${profitLossDisplay}</span></div>
                        <div class="signal-info-item"><strong>Entry Time:</strong> <span>${signal.entry_time ? new Date(signal.entry_time).toLocaleString() : 'N/A'}</span></div>
                        <div class="signal-info-item"><strong>Exit Time:</strong> <span>${signal.exit_time ? new Date(signal.exit_time).toLocaleString() : 'N/A'}</span></div>
                        <div class="signal-info-item"><strong>Interval:</strong> <span>${signal.timeframe || 'N/A'}</span></div>
                    </div>
                    <div class="chart-container" id="${chartContainerId}"></div>
                </div>
            `;
        }

        // Functions to show and hide the modal
        function showModal(strategyName, signals) {
            document.getElementById('modal-strategy-title').textContent = `${strategyName} Signals`;
            renderSignalsInModal(signals);
            document.getElementById('signalModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('signalModal').style.display = 'none';
            document.querySelectorAll('#modal-signals-container .chart-container').forEach(container => {
                container.innerHTML = '';
            });
        }

        /**
         * Reverts the view to show all signals.
         */
        function showAllSignalsView() {
            renderSignals();
        }

        // Initial data fetch and rendering
        document.addEventListener('DOMContentLoaded', async () => {
            allSignalsData = await fetchSignals();
            updateSummaryStatistics(allSignalsData);
            showAllSignalsView();

            // Add event listener to the strategy grid for showing the modal
            document.getElementById('strategyStatsGrid').addEventListener('click', (event) => {
                const card = event.target.closest('.strategy-card');
                if (card) {
                    const strategyName = card.dataset.strategyName;
                    const strategySignals = allSignalsData.filter(s => s.strategy_name === strategyName);
                    showModal(strategyName, strategySignals);
                }
            });

            // Add event listeners for closing the modal
            document.querySelector('.close-button').addEventListener('click', closeModal);
            window.addEventListener('click', (event) => {
                const modal = document.getElementById('signalModal');
                if (event.target === modal) {
                    closeModal();
                }
            });

            // Event listeners for the filter stats
            document.getElementById('totalSignalsItem').addEventListener('click', showAllSignalsView);
            document.getElementById('openSignalsItem').addEventListener('click', renderAllOpenSignals);
            document.getElementById('openSignals5MinItem').addEventListener('click', renderOpenSignalsLast5Min);

            setInterval(async () => {
                console.log("Refreshing data...");
                const refreshedData = await fetchSignals();
                allSignalsData = refreshedData;
                updateSummaryStatistics(allSignalsData);

                // Re-render the correct view based on the current state
                if (currentView === 'all_signals') {
                    renderSignals();
                } else if (currentView === 'all_open') {
                    renderAllOpenSignals();
                } else if (currentView === '5_min_open') {
                    renderOpenSignalsLast5Min();
                }
            }, 300000); // 5 minutes
        });
    </script>
</body>
</html>
